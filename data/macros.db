{"_id":"1ZMc23sjzr1h5GAG","name":"d6","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d6","author":"NGNjNjcwYTg1OTY5","img":"icons/png/perspective-dice-six.png","actorIds":[]}
{"_id":"1gJy5LTYc6xpUln4","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d10","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Enlarge/Reduce","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/link-blue-2.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Enlarge/Reduce\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"23BY47RmTmrdyY8b"}
{"name":"Great Weapon Master","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/*\nCreated Monkan#8752 with guidance from the Rage macro in the FVTT Community Macros\n\nTips to make it work\n 1 -    Have a feature called 'Great Weapon Master' for your character.\n 2 -    Make sure you have your weapons with Heavy property filled out. \n 3 -    if you make any changes to your damage or attack calculations, make sure you toggle it off.\n        As it stores the old values to replace once you disable the feat.  It could undo your changes.\n*/\n\nlet gwm='';\nlet chatMsg='';\n\n\nif (actor !== undefined && actor !== null) {\n    // find the feat Great Weapon Master\n    gwm = actor.items.find(i => i.name === 'Great Weapon Master');\n    if (gwm == undefined) { \n        ui.notifications.warn(\"Please select a single token with the Great Weapon Master feat.\");        \n    }\n\n    if (gwm !== undefined && gwm !== null) {\n\t\tchatMsg = '';\n\t\tlet enabled = false;\n\t\t// store the state of the GWM toggle in flags\n\t\tif (actor.data.flags.gwmMacro !== null && actor.data.flags.gwmMacro !== undefined) {\n\t\t\tenabled = true;\n\t\t}\n\t\t// if GWM is active, disable it\n\t\tif (enabled) {\n            chatMsg = `${actor.name} is swinging Normally now.`;\n            \n            let obj = {};\n\t\t\tobj['flags.gwmMacro'] = null;\t\t\t\n\t\t\tactor.update(obj);\n\n\t\t\t// reset items\n\t\t\tfor (let item of actor.items) {\n\t\t\t\tif (item.data.flags.gwmMacro !== null && item.data.flags.gwmMacro !== undefined) {\n\t\t\t\t\t// restoring the old value from flags\n                    let oldDmg = item.data.flags.gwmMacro.oldDmg;\n                    let oldAtk = item.data.flags.gwmMacro.oldAtk;\n\t\t\t\t\tlet obj = {};\n                    obj['data.damage.parts'] = oldDmg;\n                    obj['data.attackBonus'] = oldAtk;\n\t\t\t\t\tobj['flags.gwmMacro'] = null;\n\t\t\t\t\titem.update(obj);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t// if GWM is disabled, enable it\n\t\t} else {\n            chatMsg = `${actor.name} is swinging Harder!`;\n            \n            let obj = {};\n\t\t\tobj['flags.gwmMacro.enabled'] = true;\n\t\t\tactor.update(obj);\n\n            // update items\n            let gwmAtk = -5;\n\t\t\tlet gwmDmg = 10;\n\t\t\tfor (let item of actor.items) {\n                let isMelee = getProperty(item, 'data.data.actionType') === 'mwak';\n                let isHeavy = getProperty(item, 'data.data.properties.hvy')\n\t\t\t\tif (isMelee && isHeavy && item.data.data.damage.parts.length > 0) {\n\t\t\t\t\tconsole.log('updating ' + item);\n                    let obj = {};\n                    let atk = item.data.data.attackBonus;\n                    let dmg = item.data.data.damage.parts;\n                    // Save old attack and damage values\n                    obj['flags.gwmMacro.oldDmg'] = JSON.parse(JSON.stringify(dmg));\n                    obj['flags.gwmMacro.oldAtk'] = JSON.parse(JSON.stringify(atk));\n                    // Set the new attack and damage values\n                    if (atk !== null) {\n                        atk += '' + gwmAtk;\n                    } else {\n                        atk = gwmAtk;\n                    }\n\t\t\t\t\tdmg[0][0] = `${dmg[0][0]} + ${gwmDmg}`;\n                    obj['data.damage.parts'] = dmg;\n                    obj['data.attackBonus'] = atk;\n\t\t\t\t\titem.update(obj);\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n    }\n\n} else ui.notifications.warn(\"Please select a token.\");\n\n// write to chat if needed:\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n    };\n\tChatMessage.create(chatData, {});\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.vheIbl4B1rqHjyxJ"},"scene-packer":{"hash":"5bf70e775f4a8fb0c58b07425f7b2c6cb0b05a24"}},"_id":"2HmCHbPvESHl5IwM"}
{"name":"Relink compendium entries","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/book.svg","scope":"global","command":"// This macro will let you choose your module and will check\n// each Journal and Item in your module's compendium in an\n// attempt to update the link to the equivalent compendium\n// version.\n//\n// Asks you whether you want to operate in a \"dry run\" mode,\n// where no changes are made. Check the Console for output.\n\nScenePacker.PromptRelinkJournalEntries()","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.1vPAJ3r886Km4CSi"},"scene-packer":{"hash":"33a9fa3e4cc07d6deea0355ed0463ab596443bd6"}},"_id":"3pcihciucCFoO8U3"}
{"name":"Halo of Spores","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Halo of Spores\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"58ZOm8tOQbpGjsfU"}
{"name":"Symbiotic Entity","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Symbiotic Entity\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"5aag5JxnPcsbZv6O"}
{"name":"Alarm","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Alarm\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/runes-royal-1.jpg","actorIds":[],"_id":"5af4NDJu76NioEy3"}
{"name":"Cure Wounds","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Cure Wounds\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/heal-jade-1.jpg","actorIds":[],"_id":"5gBzsgyW7bAw1qOV"}
{"name":"Call Lightning","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/lighting-sky-2.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Call Lightning\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"6JWHeFXoDWDzwRc7"}
{"name":"Pass without Trace","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Pass without Trace\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/fog-air-1.jpg","actorIds":[],"_id":"6UlDrkITiky382th"}
{"_id":"6aol2kkh7RFD8rDs","name":"1d20","permission":{"default":0,"ZGFkODQ5MzM2NTJk":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20","author":"ZGFkODQ5MzM2NTJk","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"6tBZ7EgjHUadmnhB","name":"New Macro","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d100","author":"NGNjNjcwYTg1OTY5","img":"icons/png/dpercent.png","actorIds":[]}
{"_id":"74Ld4svNAV6OB4Rh","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d12","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Cure Wounds","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Cure Wounds\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/heal-jade-1.jpg","actorIds":[],"_id":"77SvsasoYSIvGAA4"}
{"_id":"78x47To8NqWfZEmA","name":"1d20","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"All Tokenâ€™s Passive Perception","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Pull the passive perception of each token in the current scene and whisper the results to the GM.\n// Only tested with the 5e System in Foundry.\n// Author: @Drunemeton#7955. Based on the original macro by author @Erogroth#7134.\n\n// Initalize variables.\nlet pcArray = [];\nlet npcArray = [];\nlet messageContentPC = \"\";\nlet messageContentNPC = \"\";\nlet messageHeaderPC = \"<b>PC Passive Perception</b><br>\";\nlet messageHeaderNPC = \"<b>NPC Passive Perception</b><br>\";\n\n// Gather tokens in the current scene into an array.\nlet tokens = canvas.tokens.placeables.filter((token) => token.data && token.actor);\n\n// From the tokens array sort into PC and NPC arrays.\nfor (let count of tokens) {\n  let tokenType = count.actor.data.type;\n  let tokenName = count.data.name;\n  let tokenPassive = count.actor.data.data.skills.prc.passive;\n  \n  if(tokenType === \"character\") {\n    pcArray.push({ name: tokenName, passive: tokenPassive });\n  } \n  if(tokenType === \"npc\") {\n    npcArray.push({ name: tokenName, passive: tokenPassive });\n  }\n}\n\n// Sort each array.\nsortArray(pcArray);\nsortArray(npcArray);\n\n// Build chat message, with PCs first, then NPCs.\nfor (let numPC of pcArray) {\n  messageContentPC += `${numPC.name}: <b>${numPC.passive}</b><br>`;\n}\nfor (let numNPC of npcArray) {\n  messageContentNPC += `${numNPC.name}: <b>${numNPC.passive}</b><br>`;\n}\n\nlet chatMessage = (messageHeaderPC + messageContentPC + `<br>` + messageHeaderNPC + messageContentNPC);\n\nlet chatData = {\n  user: game.user._id,\n  speaker: ChatMessage.getSpeaker(),\n  content: chatMessage,\n  whisper: game.users.filter((u) => u.isGM).map((u) => u._id),\n};\n\n// Display chat message.\nChatMessage.create(chatData, {});\n\n// Sort each array by Name.\n  function sortArray(checkArray) {\n    checkArray.sort(function (a, b) {\n      var nameA = a.name.toUpperCase(); // ignore upper and lowercase\n      var nameB = b.name.toUpperCase(); // ignore upper and lowercase\n      if (nameA < nameB) {\n        return -1;\n      }\n      if (nameA > nameB) {\n        return 1;\n      }\n      // names must be equal\n      return 0;\n    });\n\n    // Sort array by Passive Perception.\n    checkArray.sort(function (a, b) {\n      return b.passive - a.passive;\n    });\n  }","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.DBlk2wFOpxxhM9eC"},"scene-packer":{"hash":"3a39a78fceabada72a49628515cc93c106ad3c54"}},"_id":"7hCqo49LGKuHrCmj"}
{"_id":"7oBxEwUVd6M0A8ow","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d100","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"8LAZ2ZMKVJ1p3KSs","name":"2d20","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"script","sort":100001,"flags":{},"scope":"global","command":"/r 2d20","author":"NGNjNjcwYTg1OTY5","img":"icons/png/dice-twenty-faces-twenty-adv.png","actorIds":[]}
{"_id":"8hf8gQNO2np0ylr0","name":"update paths to s3","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/save.svg","scope":"global","command":"/*\nReplace image references\n */\n(async () => {\n  let find = 'https://gloomygus.s3.us-east-2.amazonaws.com/beneostokens/*/*/*.webm';\n  let replace = 'https://gloomygus.s3.us-east-2.amazonaws.com/beneostokens/*/*.webm';\n  for (const scene of game.scenes) {\n    if (scene.data.img?.startsWith(find)) {\n      console.log(`${scene.name}.img: ${scene.data.img} => ${scene.data.img.replace(find, replace)}`);\n      await scene.update({img: scene.data.img.replace(find, replace)});\n    }\n    if (scene.data.foreground?.startsWith(find)) {\n      console.log(`${scene.name}.foreground: ${scene.data.foreground} => ${scene.data.foreground.replace(find, replace)}`);\n      await scene.update({img: scene.data.foreground.replace(find, replace)});\n    }\n    const tokenUpdates = [];\n    for (const token of scene.tokens) {\n      if (token.data.img?.startsWith(find)) {\n        console.log(`${token.name}.img: ${token.data.img} => ${token.data.img.replace(find, replace)}`);\n        tokenUpdates.push({_id: token.id, img: token.data.img.replace(find, replace)});\n      }\n    }\n    if (tokenUpdates.length) {\n      await scene.updateEmbeddedDocuments('Token', tokenUpdates);\n    }\n    const tileUpdates = [];\n    for (const tile of scene.tiles) {\n      if (tile.data.img?.startsWith(find)) {\n        console.log(`tile.img: ${tile.data.img} => ${tile.data.img.replace(find, replace)}`);\n        tileUpdates.push({_id: tile.id, img: tile.data.img.replace(find, replace), locked:true});\n      } else {\n        tileUpdates.push({_id: tile.id, locked:true});\n      }\n    }\n    if (tileUpdates.length) {\n      await scene.updateEmbeddedDocuments('Tile', tileUpdates);\n    }\n  }\n\n  for (const actor of game.actors) {\n    if (actor.data.img?.startsWith(find)) {\n      console.log(`${actor.name}.img: ${actor.data.img} => ${actor.data.img.replace(find, replace)}`);\n      await actor.update({img: actor.data.img.replace(find, replace)});\n    }\n    if (actor.data.token.img?.startsWith(find)) {\n      console.log(`${actor.data.token.name}.token.img: ${actor.data.token.img} => ${actor.data.token.img.replace(find, replace)}`);\n      await actor.update({token: {img: actor.data.token.img.replace(find, replace)}});\n    }\n    const itemUpdates = [];\n    for (const item of actor.data.items) {\n      if (item.data.img?.startsWith(find)) {\n        console.log(`${actor.name} ${item.name} item.img: ${item.data.img} => ${item.data.img.replace(find, replace)}`);\n        itemUpdates.push({_id: item.id, img: item.data.img.replace(find, replace)});\n      }\n    }\n    if (itemUpdates.length) {\n      await actor.updateEmbeddedDocuments('Item', itemUpdates);\n    }\n    const effectUpdates = [];\n    for (const effect of actor.data.effects) {\n      if (effect.data.img?.startsWith(find)) {\n        console.log(`${actor.name} ${effect.name} effect.img: ${effect.data.img} => ${effect.data.img.replace(find, replace)}`);\n        effectUpdates.push({_id: effect.id, img: effect.data.img.replace(find, replace)});\n      }\n    }\n    if (effectUpdates.length) {\n      await actor.updateEmbeddedDocuments('ActiveEffect', effectUpdates);\n    }\n  }\n\n  for (const item of game.items) {\n    if (item.data.img?.startsWith(find)) {\n      console.log(`${item.name}.img: ${item.data.img} => ${item.data.img.replace(find, replace)}`);\n      await item.update({img: item.data.img.replace(find, replace)});\n    }\n    const effectUpdates = [];\n    for (const effect of item.data.effects) {\n      if (effect.data.img?.startsWith(find)) {\n        console.log(`${item.name} ${effect.name} effect.img: ${effect.data.img} => ${effect.data.img.replace(find, replace)}`);\n        effectUpdates.push({_id: effect.id, img: effect.data.img.replace(find, replace)});\n      }\n    }\n    if (effectUpdates.length) {\n      await item.updateEmbeddedDocuments('ActiveEffect', effectUpdates);\n    }\n  }\n\n  for (const journal of game.journal) {\n    if (journal.data.img?.startsWith(find)) {\n      console.log(`${journal.name}.img: ${journal.data.img} => ${journal.data.img.replace(find, replace)}`);\n      await journal.update({img: journal.data.img.replace(find, replace)});\n    }\n  }\n\n  // Playlists\n  for (const playlist of game.playlists) {\n    const soundUpdates = [];\n    for (const sound of playlist.data?.sounds) {\n      if (sound.data.path?.startsWith(find)) {\n        console.log(`${sound.name}.img: ${sound.data.path} => ${sound.data.path.replace(find, replace)}`);\n        soundUpdates.push({_id: sound.id, path: sound.data.path.replace(find, replace)});\n      }\n    }\n    if (soundUpdates.length) {\n      await playlist.updateEmbeddedDocuments('PlaylistSound', soundUpdates);\n    }\n  }\n})();","folder":null,"sort":0,"permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"flags":{"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"8zzfz46U19dkHV3d","name":"34 - T03 - Blood Bath (splash)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/blood.svg","scope":"global","command":"let params =\n    [{\n        filterType: \"splash\",\n        filterId: \"mySplash\",\n        color: 0xFF0505,\n        padding: 80,\n        time: 0,\n        seed: 0.10,\n        splashFactor: 2.25,\n        spread: 7,\n        blend: 7,\n        dimX: 1,\n        dimY: 1,\n        alphaBlending: false,\n        alphaDiscard: true,\n        cut: true,\n        animated :\n        {\n          time : \n          { \n            active: true, \n            speed: 0.0009, \n            animType: \"move\" \n          }\n        }\n    }];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.CRwxsDAsfCkXXTOa"},"scene-packer":{"hash":"224f71f5ad1de636d89441bfde162cf7c14604ff"},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"A1Sdz7jeD5STzKBx","name":"Perception","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20+6 # Perception","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"A6XuyvDF5Crxfbsd","name":"Initiative","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20 + 3","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"ACD5Yb8dhk5MINYO","name":"Wizard","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"icons/magic/air/wind-tornado-wall-blue.webp","scope":"global","command":"game.dnd5e.rollItemMacro(\"Wizard\");","folder":null,"sort":100001,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}}}
{"name":"Bulk replace asset references","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/lightning.svg","scope":"global","command":"/*\n * Bulk replace asset references\n */\n(async () => {\n  Dialog.prompt({\n    title: \"Bulk replace asset references\",\n    content:\n      '<p>This tool will search for asset references <strong>within your world</strong> that start with the provided value and replace that portion with the other provided value.</p><p><label>Find (case sensitive): <input type=\"text\" name=\"find\" placeholder=\"some/original/path/\"></label></p><p><label>Replace (case sensitive): <input type=\"text\" name=\"replace\" placeholder=\"your/new/path/\"></label></p><hr><p><label><input type=\"checkbox\"> Save changes?</label></p><p>Leaving this unchecked will operate in a \"dry run\" mode, where changes are only output to the console (F12).</p><hr>',\n    label: \"Bulk replace\",\n    callback: async (html) => {\n      const find = html.find('input[name=\"find\"]').val();\n      const replace = html.find('input[name=\"replace\"]').val();\n      const dryRun = !html.find('input[type=\"checkbox\"]')[0].checked;\n      if (!find || !replace) {\n        console.warn(\"Bulk replace asset references: No value provided\");\n        return;\n      }\n      const domParser = new DOMParser();\n\n      console.groupCollapsed(\"Bulk replace scenes\");\n      for (const scene of game.scenes) {\n        if (scene.data.img?.startsWith(find)) {\n          console.log(\n            `${scene.name}.img: ${scene.data.img} => ${scene.data.img.replace(\n              find,\n              replace\n            )}`\n          );\n          if (!dryRun) {\n            await scene.update({ img: scene.data.img.replace(find, replace) });\n          }\n        }\n        if (scene.data.foreground?.startsWith(find)) {\n          console.log(\n            `${scene.name}.foreground: ${\n              scene.data.foreground\n            } => ${scene.data.foreground.replace(find, replace)}`\n          );\n          if (!dryRun) {\n            await scene.update({\n              img: scene.data.foreground.replace(find, replace),\n            });\n          }\n        }\n        const tokenUpdates = [];\n        let shownGroup = false;\n        for (const token of scene.tokens) {\n          if (token.data.img?.startsWith(find)) {\n            if (!shownGroup) {\n              console.groupCollapsed(`${scene.name} tokens`);\n              shownGroup = true;\n            }\n            console.log(\n              `${token.name}.img: ${token.data.img} => ${token.data.img.replace(\n                find,\n                replace\n              )}`\n            );\n            tokenUpdates.push({\n              _id: token.id,\n              img: token.data.img.replace(find, replace),\n            });\n          }\n        }\n        if (shownGroup) {\n          console.groupEnd();\n        }\n        if (tokenUpdates.length && !dryRun) {\n          await scene.updateEmbeddedDocuments(\"Token\", tokenUpdates);\n        }\n        const tileUpdates = [];\n        shownGroup = false;\n        for (const tile of scene.tiles) {\n          if (tile.data.img?.startsWith(find)) {\n            if (!shownGroup) {\n              console.groupCollapsed(`${scene.name} tiles`);\n              shownGroup = true;\n            }\n            console.log(\n              `tile.img: ${tile.data.img} => ${tile.data.img.replace(\n                find,\n                replace\n              )}`\n            );\n            tileUpdates.push({\n              _id: tile.id,\n              img: tile.data.img.replace(find, replace),\n            });\n          }\n        }\n        if (shownGroup) {\n          console.groupEnd();\n        }\n        if (tileUpdates.length && !dryRun) {\n          await scene.updateEmbeddedDocuments(\"Tile\", tileUpdates);\n        }\n      }\n      console.groupEnd();\n\n      console.groupCollapsed(\"Bulk replace actors\");\n      for (const actor of game.actors) {\n        if (actor.data.img?.startsWith(find)) {\n          console.log(\n            `${actor.name}.img: ${actor.data.img} => ${actor.data.img.replace(\n              find,\n              replace\n            )}`\n          );\n          if (!dryRun)\n            await actor.update({ img: actor.data.img.replace(find, replace) });\n        }\n        if (actor.data.token.img?.startsWith(find)) {\n          console.log(\n            `${actor.data.token.name}.token.img: ${\n              actor.data.token.img\n            } => ${actor.data.token.img.replace(find, replace)}`\n          );\n          if (!dryRun) {\n            await actor.update({\n              token: { img: actor.data.token.img.replace(find, replace) },\n            });\n          }\n        }\n        const itemUpdates = [];\n        shownGroup = false;\n        for (const item of actor.data.items) {\n          if (item.data.img?.startsWith(find)) {\n            if (!shownGroup) {\n              console.groupCollapsed(`${actor.name} tokens`);\n              shownGroup = true;\n            }\n            console.log(\n              `${actor.name} ${item.name} item.img: ${\n                item.data.img\n              } => ${item.data.img.replace(find, replace)}`\n            );\n            itemUpdates.push({\n              _id: item.id,\n              img: item.data.img.replace(find, replace),\n            });\n          }\n        }\n        if (shownGroup) {\n          console.groupEnd();\n        }\n        if (itemUpdates.length && !dryRun) {\n          await actor.updateEmbeddedDocuments(\"Item\", itemUpdates);\n        }\n        const effectUpdates = [];\n        shownGroup = false;\n        for (const effect of actor.data.effects) {\n          if (effect.data.img?.startsWith(find)) {\n            if (!shownGroup) {\n              console.groupCollapsed(`${actor.name} effects`);\n              shownGroup = true;\n            }\n            console.log(\n              `${actor.name} ${effect.name} effect.img: ${\n                effect.data.img\n              } => ${effect.data.img.replace(find, replace)}`\n            );\n            effectUpdates.push({\n              _id: effect.id,\n              img: effect.data.img.replace(find, replace),\n            });\n          }\n        }\n        if (shownGroup) {\n          console.groupEnd();\n        }\n        if (effectUpdates.length && !dryRun) {\n          await actor.updateEmbeddedDocuments(\"ActiveEffect\", effectUpdates);\n        }\n      }\n      console.groupEnd();\n\n      console.groupCollapsed(\"Bulk replace items\");\n      for (const item of game.items) {\n        if (item.data.img?.startsWith(find)) {\n          console.log(\n            `${item.name}.img: ${item.data.img} => ${item.data.img.replace(\n              find,\n              replace\n            )}`\n          );\n          if (!dryRun) {\n            await item.update({ img: item.data.img.replace(find, replace) });\n          }\n        }\n        const effectUpdates = [];\n        shownGroup = false;\n        for (const effect of item.data.effects) {\n          if (effect.data.img?.startsWith(find)) {\n            if (!shownGroup) {\n              console.groupCollapsed(`${item.name} effects`);\n              shownGroup = true;\n            }\n            console.log(\n              `${item.name} ${effect.name} effect.img: ${\n                effect.data.img\n              } => ${effect.data.img.replace(find, replace)}`\n            );\n            effectUpdates.push({\n              _id: effect.id,\n              img: effect.data.img.replace(find, replace),\n            });\n          }\n        }\n        if (shownGroup) {\n          console.groupEnd();\n        }\n        if (effectUpdates.length && !dryRun) {\n          await item.updateEmbeddedDocuments(\"ActiveEffect\", effectUpdates);\n        }\n      }\n      console.groupEnd();\n\n      console.groupCollapsed(\"Bulk replace journals\");\n      for (const journal of game.journal) {\n        if (journal.data.img?.startsWith(find)) {\n          console.log(\n            `${journal.name}.img: ${\n              journal.data.img\n            } => ${journal.data.img.replace(find, replace)}`\n          );\n          if (!dryRun) {\n            await journal.update({\n              img: journal.data.img.replace(find, replace),\n            });\n          }\n        }\n        if (journal.data.content) {\n          let hasContentUpdate = false;\n          const doc = domParser.parseFromString(journal.data.content, 'text/html');\n          for (const link of doc.getElementsByTagName('a')) {\n            if (link.href?.startsWith(find)) {\n              console.log(\n                `${journal.name}.link: ${\n                  link.href\n                } => ${link.href.replace(find, replace)}`\n              );\n              link.href.replace(find, replace);\n              hasContentUpdate = true;\n            }\n          }\n          for (const link of doc.getElementsByTagName('img')) {\n            if (link.src?.startsWith(find)) {\n              console.log(\n                `${journal.name}.img: ${\n                  link.src\n                } => ${link.src.replace(find, replace)}`\n              );\n              link.src.replace(find, replace);\n              hasContentUpdate = true;\n            }\n          }\n\n          if (hasContentUpdate && !dryRun) {\n            await journal.update({\n              content: doc.body.innerHTML,\n            });\n          }\n        }\n      }\n      console.groupEnd();\n\n      console.groupCollapsed(\"Bulk replace playlists\");\n      for (const playlist of game.playlists) {\n        const soundUpdates = [];\n        for (const sound of playlist.data?.sounds) {\n          if (sound.data.path?.startsWith(find)) {\n            console.log(\n              `${sound.name}.img: ${\n                sound.data.path\n              } => ${sound.data.path.replace(find, replace)}`\n            );\n            soundUpdates.push({\n              _id: sound.id,\n              path: sound.data.path.replace(find, replace),\n            });\n          }\n        }\n        if (soundUpdates.length && !dryRun) {\n          await playlist.updateEmbeddedDocuments(\"PlaylistSound\", soundUpdates);\n        }\n      }\n      console.groupEnd();\n    },\n  });\n})();","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.YpZnc0IWBVWtIoJO"},"scene-packer":{"sourceId":"Macro.YpZnc0IWBVWtIoJO","hash":"28c56de8fd4c61fd2f85c3b7f92376b274e32a41"}},"_id":"ART0crV3lJzgHkSw"}
{"name":"Healing Word","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Healing Word\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/heal-jade-1.jpg","actorIds":[],"_id":"B4426WtmXC6LFLDr"}
{"name":"Lesser Restoration","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/heal-sky-1.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Lesser Restoration\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"BG6hMHB3dqetbZrG"}
{"_id":"BebQRgZB17J2EJR3","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d6","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"19 - T01 - Fire","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"fire\",\r\n    filterId: \"myFire\",\r\n    intensity: 1,\r\n    color: 0xFFFFFF,\r\n    amplitude: 1,\r\n    time: 0,\r\n    blend: 2,\r\n    fireBlend : 1,\r\n    animated :\r\n    {\r\n      time : \r\n      { \r\n        active: true, \r\n        speed: -0.0024, \r\n        animType: \"move\" \r\n      },\r\n      intensity:\r\n      {\r\n        active:true,\r\n        loopDuration: 15000,\r\n        val1: 0.8,\r\n        val2: 2,\r\n        animType: \"syncCosOscillation\"\r\n      },\r\n      amplitude:\r\n      {\r\n        active:true,\r\n        loopDuration: 4400,\r\n        val1: 1,\r\n        val2: 1.4,\r\n        animType: \"syncCosOscillation\"\r\n      }\r\n      \r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.F47j6ivhmXxeYVmY"}},"_id":"BhsZsbbsJE5CiZRo"}
{"_id":"CgDWipIejX1xUjGr","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d8","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"CgKYcbEGBqGW6z6y","name":"All Tokenâ€™s Passive Perception","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Pull the passive perception of each token in the current scene and whisper the results to the GM.\n// Only tested with the 5e System in Foundry.\n// Author: @Drunemeton#7955. Based on the original macro by author @Erogroth#7134.\n\n// Initalize variables.\nlet pcArray = [];\nlet npcArray = [];\nlet messageContentPC = \"\";\nlet messageContentNPC = \"\";\nlet messageHeaderPC = \"<b>PC Passive Perception</b><br>\";\nlet messageHeaderNPC = \"<b>NPC Passive Perception</b><br>\";\n\n// Gather tokens in the current scene into an array.\nlet tokens = canvas.tokens.placeables.filter((token) => token.data && token.actor);\n\n// From the tokens array sort into PC and NPC arrays.\nfor (let count of tokens) {\n  let tokenType = count.actor.data.type;\n  let tokenName = count.data.name;\n  let tokenPassive = count.actor.data.data.skills.prc.passive;\n  \n  if(tokenType === \"character\") {\n    pcArray.push({ name: tokenName, passive: tokenPassive });\n  } \n  if(tokenType === \"npc\") {\n    npcArray.push({ name: tokenName, passive: tokenPassive });\n  }\n}\n\n// Sort each array.\nsortArray(pcArray);\nsortArray(npcArray);\n\n// Build chat message, with PCs first, then NPCs.\nfor (let numPC of pcArray) {\n  messageContentPC += `${numPC.name}: <b>${numPC.passive}</b><br>`;\n}\nfor (let numNPC of npcArray) {\n  messageContentNPC += `${numNPC.name}: <b>${numNPC.passive}</b><br>`;\n}\n\nlet chatMessage = (messageHeaderPC + messageContentPC + `<br>` + messageHeaderNPC + messageContentNPC);\n\nlet chatData = {\n  user: game.user._id,\n  speaker: ChatMessage.getSpeaker(),\n  content: chatMessage,\n  whisper: game.users.filter((u) => u.isGM).map((u) => u._id),\n};\n\n// Display chat message.\nChatMessage.create(chatData, {});\n\n// Sort each array by Name.\n  function sortArray(checkArray) {\n    checkArray.sort(function (a, b) {\n      var nameA = a.name.toUpperCase(); // ignore upper and lowercase\n      var nameB = b.name.toUpperCase(); // ignore upper and lowercase\n      if (nameA < nameB) {\n        return -1;\n      }\n      if (nameA > nameB) {\n        return 1;\n      }\n      // names must be equal\n      return 0;\n    });\n\n    // Sort array by Passive Perception.\n    checkArray.sort(function (a, b) {\n      return b.passive - a.passive;\n    });\n  }","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.DBlk2wFOpxxhM9eC"},"scene-packer":{"hash":"3a39a78fceabada72a49628515cc93c106ad3c54"},"combat-utility-belt":{"macroTrigger":""}}}
{"name":"Bulk Unpack Scenes","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/up.svg","scope":"global","command":"// This macro will unpack any scenes in your world that have\n// packed data. It can be used to prevent you needing to go\n// through activating each scene one by one.\n(async () => {\n  ScenePacker.PromptForInstance().then(async instance => {\n    if (!instance?.moduleName) {\n      return;\n    }\n\n    const scenes = [];\n    for (const scene of game.scenes) {\n      if (ScenePacker.HasPackedData(scene, instance.moduleName)) {\n        scenes.push(scene);\n      }\n    }\n    if (!scenes.length) {\n      return ui.notifications.info(`There are no scenes that need unpacking in \\\"${instance.moduleName}\\\".`);\n    }\n\n    ui.notifications.info(`Unpacking ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n    console.log(`Unpacking ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n    for (const scene of scenes) {\n      await instance.ProcessScene(scene, {showLinkedJournal: false, showUI: false});\n    }\n    ui.notifications.info(`Done. Unpacked ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n    console.log(`Done. Unpacked ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n  });\n})();","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.cRYEZq7UjvUNZ8g5"},"scene-packer":{"sourceId":"Macro.cRYEZq7UjvUNZ8g5","hash":"bd0d6249ed5ef1512a317da03e5b690ffd174f90"}},"_id":"D8PMyUcSCe3Rj3SG"}
{"name":"Healing Spirit","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Healing Spirit\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"DmDhnQIt8EHy0bFx"}
{"_id":"F1HIflltnlJc6GX0","name":"Summon Beast Damage","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"chat","sort":100001,"flags":{"combat-utility-belt":{"macroTrigger":""}},"scope":"global","command":"/r 1d8 +4 + 2 # Summon Beast Damage (Maul)","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Aura of Vitality","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Aura of Vitality\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"FdHXKPsbPN9BVEPj"}
{"_id":"FtdOgK0TPmlHRRKk","name":"1d20","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20","author":"NGIwMDczNDc3YmVi","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Random Inspiration","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Courtesy of @Zarek\n// Selected target receives a random inspiration from a table called \"inspirations\".\n// You can find a table called inspirations in the community tables module\n\n// Setup variables\nlet tableName = \"Inspirations\";\n\nlet bardicInspiration = async() => {\n  if (!actor) {\n    ui.notifications.warn(\"You must have an actor selected.\");\n    return\n  }\n\n  // Get Targets name\n  let actorLevels = actor.data.data.levels || 1;\n  const targetId = game.user.targets.ids[0];\n  const targetToken = canvas.tokens.get(targetId);\n  if (!targetToken) {\n    ui.notifications.warn(\"You must target a token.\");\n    return\n  }\n  const targetName = targetToken.name;\n\n\n  let table = game.tables.contents.find(t => t.name == tableName);\n\n  //default inspiration if no table is found.\n  //let inspiration = \"Cowards die many times before their deaths; the valiant never taste death but once.\";\n  let inspiration = `I don't know what effect ${targetName} will have upon the enemy, but, by God, he terrifies me.`;\n  \n  // Roll the result, and mark it drawn\n  if (table) {\n    if (checkTable(table)) {\n      // let result = table.roll()[1];\n      let roll = await table.roll();\n      let result = roll.results[0];\n      inspiration = result.data.text;\n      await table.updateEmbeddedDocuments(\"TableResult\", [{\n        _id: result.id,\n        drawn: true\n      }]);\n    }\n  }\n\n  function checkTable(table) {\n    let results = 0;\n    for (let data of table.data.results) {\n      if (!data.drawn) {\n        results++;\n      }\n    }\n    if (results < 1) {\n      table.reset();\n      ui.notifications.notify(\"Table Reset\")\n      return false\n    }\n    return true\n  }\n\n  let dieType = 'd6';\n  if (actorLevels >= 15) {\n    dieType = 'd12';\n  } else if (actorLevels >= 10) {\n    dieType = 'd10';\n  } else if (actorLevels >= 5) {\n    dieType = 'd8';\n  }\n\n  let messageContent = '';\n  messageContent += `<p>${token.name} exclaims <b><i>\"${inspiration}\"</i></b></p>`\n  messageContent += `<p>${targetName} is inspired.</p>`\n  messageContent += `<details closed=\"\"><summary><a>Bardic Inspiration</a></summary><p>${targetName} gains one Bardic Inspiration die, a <strong>${dieType}</strong>.<br>Once within the next 10 minutes, ${targetName} can roll the die and add the number rolled to one <b>ability check, attack roll, or saving throw</b>. ${targetName} can wait until after it rolls the <strong>d20</strong> before deciding to use the Bardic Inspiration die, but must decide before the DM says whether the roll succeeds or fails. Once the Bardic Inspiration die is rolled, it is lost.</p></details>`\n\n  // create the message\n  if (messageContent !== '') {\n    let chatData = {\n      user: game.user.id,\n      speaker: ChatMessage.getSpeaker(),\n      content: messageContent,\n    };\n    ChatMessage.create(chatData, {});\n  }\n};\nbardicInspiration();","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.XuT5kNbIerT7CGoA"},"scene-packer":{"hash":"f47e2bad6996eb1bd899168783013bead5ec1d32"}},"_id":"FxqVSo1U8vsebCNu"}
{"name":"Sneak Attack","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"//\t\tDISCLAIMER:\t\tThis macro is heavily based on the original D&D 5e Rage Macro masterwork written by Felix#6196.\n//\t\t\t\t\t\tNorc#5108 created and is maintaining this macro.\n//\n//\t\t\t\t\t\tUpdates:\t1.\t2020/06/05: Initial version.\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tBonus Tip: Sneak Attack as a Condition                                                                                                                       \n//!!!\tIf you use the Combat Utility Belt module's Condition Lab, try adding a condition called \"Sneaky\" with the same icon \t\t\t   \n//!!!\tas the optional sneak attack icon overlay, 'icons/svg/mystery-man-black.svg' by default.  See EXPERIMENTAL MACRO ICON/NAME TOGGLE below.\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!   OPTIONAL TOKEN ICON-\tOn by default. If a path to a sneak attack icon is defined, it displays like a condition on the sneaking rogue.\n//!!!\t\t\t\t\t\t\tTo use a different icon, manually change the filepath below or leave it empty ('') to disable the effect.\n//!!!\nconst sneakIconPath = 'icons/svg/mystery-man-black.svg';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tEXPERIMENTAL MACRO ICON/NAME TOGGLE\t\tIf enabled, the macro icon and name toggles based on whether the rogue is currently sneaking. \n//!!!\t\t\t\t\t\t\t\t\t\t\tCAUTIONS: \t1. \tThis feature is off by default and is intended for ADVANCED USERS ONLY. \n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t2. \tRequires configuration using \"The Furnace\" module for a player to run!\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tThe GM needs to grant The Furnace's \"Run as GM\" permission for this macro.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t3. \tWorks best with only one rogue using this feature at a time.\n\n\t\t\t\t//To auto-toggle the macro's icon/name, override toggleMacro to true below.\n\t\t\t\tconst toggleMacro = false;\n\n\t\t\t\t//To use a different icon, manually change the filepath here\n\t\t\t\tconst stopSneakIconPath = 'icons/svg/cowled.svg';\n\n\t\t\t\t//You must update the following constant to this macro's exact name for the macro icon toggling to work.\n\t\t\t\tconst sneakMacroName = 'Sneak Attack';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\nlet toggleResult = false;\nlet enabled = false;\nlet errorReason = '';\nlet sneakAttack = {};\nlet rogue = {};\nlet rogueLvls = 0;\nlet sneakDice = 0;\nlet chatMsg = '';\nlet oldMDmg = '';\nlet oldRDmg = '';\n\nlet macroActor = actor;\nlet macroToken = token;\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tBASIC LOCALIZATION SUPPORT\t\t\t\tSets names of D&D5E features as constants instead of hardcoding to allow easier translation.\n//!!!\t\t\t\t\t\t\t\t\t\t\tSets error messages as constants also for easier translation.\n\n\t\t\t\tconst rogueClassName = 'Rogue';\n\t\t\t\tconst sneakAttackFeatureName = 'Sneak Attack';\n\n\t\t\t\tconst errorSelectRogue = 'Please select a single rogue token.';\n\t\t\t\tconst warnMacroNotFound = ' is not a valid macro name, please fix. Sneak attack toggle successful but unable to alter macro.';\n\t\t\t\tconst errorSelectToken = 'Please select a token.';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n\n//check to ensure token is selected and attempt to define the sneak attack feature\nif (macroActor !== null && macroActor !== undefined) {\n\tsneakAttack = macroActor.items.find(i => i.name == `${sneakAttackFeatureName}`);\n} else {\nerrorReason = `${errorSelectToken}`;\n}\n\n//check to ensure token is a rogue\nif (errorReason == '' && macroActor.items.find(i => i.name == `${rogueClassName}`) !== null) {\n\trogue = macroActor.items.find(i => i.name == `${rogueClassName}`);\n} else {\n\terrorReason = `${errorSelectRogue}`;\n}\n\nconsole.log(`Error reason is: ${errorReason}`);\n//main execution now that errors are caught\n\nif (errorReason == '') {\n\t\n\tchatMsg = '';\n\tlet enabled = false;\n\t// store the state of the sneak attack toggle in flags\n\tif (macroActor.data.flags.sneakMacro !== null && macroActor.data.flags.sneakMacro !== undefined) {\n\t\tenabled = true;\n\t}\n\t\n\t// if sneak attack is active, disable it\n\tif (enabled) {\n\t\tchatMsg = `${macroActor.name} is no longer sneak attacking.`;\n\t\t// ranged and melee weapon attack bonus\n\t\tlet obj = {};\n\t\tobj['flags.sneakMacro'] = null;\t\t\n\t\tobj['data.bonuses.mwak.damage'] = macroActor.data.flags.sneakMacro.oldMDmg;\t\t\t\n\t\tobj['data.bonuses.rwak.damage'] = macroActor.data.flags.sneakMacro.oldRDmg;\t\n\t\tmacroActor.update(obj);\n\t\t\n\t// if sneak attack is disabled, enable it\n\t} else {\t\t\n\t\tchatMsg = `${macroActor.name} starts sneak attacking!`;\n\t\t\n\t\tlet obj = {};\n\t\tobj['flags.sneakMacro.enabled'] = true;\n\n\t\t// Preserve old mwak damage bonus if there was one\n\t\tlet oldMDmg = macroActor.data.data.bonuses.mwak.damage;\n\t\tif (oldMDmg==null || oldMDmg == undefined || oldMDmg == '') oldMDmg = 0;\n\t\tobj['flags.sneakMacro.oldMDmg'] = JSON.parse(JSON.stringify(oldMDmg));\n\n\t\t// Preserve old rwak damage bonus if there was one\n\t\tlet oldRDmg = macroActor.data.data.bonuses.rwak.damage;\n\t\tif (oldRDmg==null || oldRDmg == undefined || oldRDmg == '') oldRDmg = 0;\n\t\tobj['flags.sneakMacro.oldRDmg'] = JSON.parse(JSON.stringify(oldRDmg));\n\n\t\t\n\t\t// Determining the rogue level\n\t\trogueLvls = rogue.data.data.levels;\n\n\t\t// Formula to determine the sneak attack damage depending on rogue level\t\n\t\tsneakDice = Math.ceil(rogueLvls/2);\n\t\n\t\t//actually add the bonus sneak attack damage to the previous bonus damage\n\t\t//respect roll formulas if present.\n\t\tif (oldMDmg==null || oldMDmg == undefined || oldMDmg == '' || oldMDmg == 0) {\n\t\t\tobj['data.bonuses.mwak.damage'] = `${sneakDice}d6`;\n\t\t} else {\n\t\t\tobj['data.bonuses.mwak.damage'] = `${oldMDmg} + ${sneakDice}d6`;\n\t\t}\n\n\t\tif (oldRDmg==null || oldRDmg == undefined || oldRDmg == '' || oldRDmg == 0) {\n\t\t\tobj['data.bonuses.rwak.damage'] = `${sneakDice}d6`;\n\t\t} else {\n\t\t\tobj['data.bonuses.rwak.damage'] = `${oldRDmg} + ${sneakDice}d6`;\n\t\t}\t\n\n\t\tmacroActor.update(obj);\n\n\t}\t\n\t\n\t//mark or unmark character's token with Sneaky effect icon, if sneakIconPath is defined\n\t(async () => { \n\t\ttoggleResult = await macroToken.toggleEffect(sneakIconPath);\n\t\tif (toggleResult == enabled) macroToken.toggleEffect(sneakIconPath);  \n\t})();\n\n\t//toggle macro icon and name, if enabled\n\tif (toggleMacro) {\n//\t\tNorc's preferred icons, not sure if publicly available\n//\t\tsneakyMacroImgPath = 'systems/dnd5e/icons/skills/shadow_17.jpg';\n//\t\tstopSneakIconPath = 'systems/dnd5e/icons/skills/yellow_11.jpg';\n\t\tlet sneakMacro = game.macros.getName(sneakMacroName);\n\t\t\t//Also check for name of macro in its \"off\" form\n\t\t\tif (sneakMacro == null || sneakMacro == undefined) {\n\t\t\t\tsneakMacro = game.macros.getName('Stop ' + sneakMacroName);\n\t\t\t}\n\t\tlet obj = {};\n\t\tif ( (sneakMacro !== null && sneakMacro !== undefined) && \n\t\t\t\t+ (stopSneakIconPath !== null && stopSneakIconPath !== undefined && stopSneakIconPath !== '') ) {\n\t\t\tif (enabled) {\n\t\t\tobj['img'] = sneakIconPath;\n\t\t\tobj['name'] = sneakMacroName;\n\t\t\t} else {\n\t\t\tobj['img'] = stopSneakIconPath;\n\t\t\tobj['name'] = 'Stop ' + sneakMacroName;\n\t\t\t}\n\t\t\tsneakMacro.update(obj);\n\t\t} else {\n\t\tui.notifications.warn(`${sneakMacroName} ${warnMacroNotFound}`);\t\t\t\n\t\t}\n\t}\n\n} else {\nui.notifications.error(`${errorReason}`);\t\n}\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n\t};\n\tChatMessage.create(chatData, {});\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.KWCb3y9I2P45LDWU"},"scene-packer":{"hash":"a10f83b204966ece8f464f39848bc4d45392ebc7"}},"_id":"FzobQA6JzSLWh0FY"}
{"_id":"Fzvb3zm6T3QWbYYs","name":"New Macro","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d8","author":"NGNjNjcwYTg1OTY5","img":"icons/png/dice-eight-faces-eight.png","actorIds":[]}
{"name":"Fungal Infestation","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Fungal Infestation\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"GOhOIZ5DoKkNFuoo"}
{"_id":"GeVp0LWVX0oWacS6","name":"delete actors","type":"script","author":"tjVuzEhXqQ9eiWAw","img":"icons/svg/dice-target.svg","scope":"global","command":"game.actors.forEach(t => { if (!t.data.folder) { t.delete(); } });","folder":null,"sort":0,"permission":{"default":0,"tjVuzEhXqQ9eiWAw":3},"flags":{}}
{"_id":"GxgLalQkb8T9lPPh","name":"22 - Smoke","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/smoke-bomb.svg","scope":"global","command":"let params =\n[{\n    filterType: \"smoke\",\n    filterId: \"mySmoke\",\n    color: 0x50FFAA,\n    time: 0,\n    blend: 2,\n    dimX: 1,\n    dimY: 1,\n    animated :\n    {\n      time : \n      { \n        active: true, \n        speed: 0.0015, \n        animType: \"move\"\n      }\n    }\n}];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.2zRNjnw7Ps26h5xz"},"combat-utility-belt":{"macroTrigger":""}}}
{"name":"Moonbeam","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Moonbeam\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/beam-blue-3.jpg","actorIds":[],"_id":"ICsXIsw4eEOtChFf"}
{"name":"Random Cutting Words","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Courtesy of @Zarek\n// Selected target receives a random cutting word from a table called \"Mockeries\" along with the roll reduction.\n// You can find a mockeries table in the community table module.\n\nlet cuttingWords = async () => {\n  // Setup variables\n  let tableName = \"mockeries\";\n  let mockery = \"Now go away or I shall taunt you a second time-a!\"; // if table can't be found, use this.\n\n  if (!actor) {\n    ui.notifications.warn(\"You must have an actor selected.\");\n    return\n  }\n\n  let actorLevels = actor.data.data.levels || 1;\n  let table = game.tables.contents.find(t => t.name == tableName);\n  // Get Targets name\n  const targetId = game.user.targets.ids[0];\n  const targetToken = canvas.tokens.get(targetId);\n  if (!targetToken) {\n    ui.notifications.warn(\"You must target a token.\");\n    return\n  }\n  const targetName = targetToken.name;\n\n  // Roll the result, and mark it drawn\n  if (table) {\n    if (checkTable(table)) {\n      let roll = await table.roll();\n      let result = roll.results[0];\n      mockery = result.data.text;\n      await table.updateEmbeddedDocuments(\"TableResult\", [{\n        _id: result.id,\n        drawn: true\n      }]);\n    }\n  }\n\n  function checkTable(table) {\n    let results = 0;\n    for (let data of table.data.results) {\n      if (!data.drawn) {\n        results++;\n      }\n    }\n    if (results < 1) {\n      table.reset();\n      ui.notifications.notify(\"Table Reset\")\n      return false\n    }\n    return true\n  }\n\n  let dieType = 'd6';\n  if (actorLevels >= 15) {\n    dieType = 'd12';\n  } else if (actorLevels >= 10) {\n    dieType = 'd10';\n  } else if (actorLevels >= 5) {\n    dieType = 'd8';\n  }\n\n  let messageContent = `<p>${targetName} Reduce your roll by: <b>[[1${dieType}]]</b>.</p>`\n  messageContent += `<p>${token.name} exclaims <b><i>\"${mockery}\"</i></b></p>`\n  messageContent += `<details closed=\"\"><summary><a>Cutting Words</a></summary>\n  <p>When a creature that you can see within 60 feet of you makes an <b>Attack roll, an ability check, or a damage roll</b>, you can use your <b>Reaction</b> to expend one of your uses of <b>Bardic Inspiration</b>,\n  rolling a Bardic Inspiration die and subtracting the number rolled from the creatureâ€™s roll.</p>\n  <p>You can choose to use this feature after the creature makes its roll, but before the GM determines whether the Attack roll or ability check succeeds or fails, or before the creature deals its damage. \n  The creature is immune if it canâ€™t hear you or if itâ€™s immune to being <b>Charmed</b>.</p></details>`\n\n  // create the message\n  if (messageContent !== '') {\n    let chatData = {\n      user: game.user.id,\n      speaker: ChatMessage.getSpeaker(),\n      content: messageContent,\n    };\n    ChatMessage.create(chatData, {});\n  }\n};\n\ncuttingWords();","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.AbzZdXi97q8oHOUn"},"scene-packer":{"hash":"d9cf7d7e3a4890e8e8c2a2b9e46b5783366674b1"}},"_id":"IHq77oeyyMHR2JK0"}
{"_id":"IKntwJ5RG8y1OXxD","name":"Sup Die","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d8","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"31 - T01 - Glowing Globes (globes)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"let params = \r\n[{\r\n    filterType: \"globes\",\r\n    filterId: \"glowingGlobes\",\r\n    time: 0,\r\n    color: 0x5099DD,\r\n    distortion: 0.4,\r\n    scale: 80,\r\n    alphaDiscard: false,\r\n    zOrder: 1,\r\n    animated :\r\n    {\r\n      time : \r\n      { \r\n        active: true, \r\n        speed: 0.0005, \r\n        animType: \"move\" \r\n      }\r\n    }\r\n}]\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.BV1FdyFefneHRoEx"}},"_id":"INCRgTC6qBhYVRcy"}
{"name":"Stealth Check","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Grabs selected tokens and rolls a stealth check against all other tokens passive perception on the map. Then returns the result.\n\n// getting all actors of selected tokens\nlet actors = canvas.tokens.controlled.map(({ actor }) => actor);\n\n// if there are no selected tokens, roll for the player's character.\nif (actors.length < 1 && game.user.character) {\n  actors = [game.user.character];\n}\nconst validActors = actors.filter(actor => actor != null);\n\nlet messageContent;\nif (validActors.length) {\n  messageContent = 'pp = passive perception<br>';\n} else {\n  messageContent = 'No tokens selected, please select at least one.';\n}\n// roll for every actor\nfor (const selectedActor of validActors) {\n  const stealthMod = selectedActor.data.data.skills.ste.total; // stealth roll\n  const result = await new Roll(`1d20+${stealthMod}`).roll({async: true});\n  const stealth = result.total; // rolling the formula\n  messageContent += `<hr><h3>${selectedActor.name} stealth roll was a <b>${stealth}</b> (1d20 + ${stealthMod}).</h3>`; // creating the output string\n\n  // grab a list of unique tokens then check their passive perception against the rolled stealth.\n  const uniqueActor = {};\n  const caughtBy = canvas.tokens.placeables\n    .filter(token => !!token.actor)\n    .filter(({ actor }) => actor.data.data.attributes.hp.value > 0) // filter out dead creatures.\n    .filter(({ actor }) => { // filter out duplicate token names. ie: we assume all goblins have the same passive perception\n      if (uniqueActor[actor.name]) {\n        return false;\n      }\n      uniqueActor[actor.name] = true;\n      return true;\n    })\n    .filter(({ actor }) => {\n      return selectedActor.id !== actor.id; // Don't check to see if the token sees himself.\n    })\n    .filter(({ actor }) => actor.data.data.skills.prc.passive >= stealth); // check map tokens passives with roller stealth\n\n  if (!caughtBy.length) {\n    messageContent += 'Stealth successful!<br>';\n  } else {\n    messageContent += 'Stealth questionable:<br>';\n    caughtBy.map(({ actor }) => {\n      messageContent += `<b>${actor.name}</b> pp(${actor.data.data.skills.prc.passive}).<br>`;\n    });\n  }\n}\n\n// create the message\nconst chatData = {\n  user: game.user._id,\n  speaker: game.user,\n  content: messageContent,\n  whisper: game.users.filter((u) => u.isGM).map((u) => u._id),\n};\nChatMessage.create(chatData, {});","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.2RitOkKtnQe9pbuF"},"scene-packer":{"hash":"ffa476b046ee00f0e1af6c8addcd29a7997229f7"}},"_id":"IYdOgeA58lqR8X6A"}
{"name":"Gaseous Form","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/fog-acid-2.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Gaseous Form\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"IdxIGYQvVVl6NVJi"}
{"name":"Conjure Animals","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/wild-orange-3.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Conjure Animals\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"JLMKpoGR17QJR1FB"}
{"_id":"Jse8Ai5Hg9pvgoqi","name":"1d20","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Reset world Scene Packer prompts","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/hanging-sign.svg","scope":"global","command":"// This macro will prompt you to select your module and then\n// will reset the settings values to allow retriggering of\n// the prompts when you first install a world.\n//\n// These prompts are the \"Yes import all\", \"Let me choose\" etc.\n\nlet content = '';\nlet instances = Object.keys(ScenePacker.instances);\nif (instances.length) {\n  content = '<p>Select the module that you want to reset prompting for:</p>';\n  content += '<select id=\"module-name\">';\n  instances.forEach(m => {\n    content += `<option value=\"${m}\">${m}</option>`;\n  });\n  content += '</select>';\n  content += '<p>Refresh the world after resetting.</p>'\n} else {\n  content = '<p>There are no modules registered with Scene Packer currently available.</p>';\n}\nlet d = new Dialog({\n  title: 'Select instance',\n  content: content,\n  buttons: {\n    relink: {\n      icon: '<i class=\"fas fa-check\"></i>',\n      label: 'Reset',\n      callback: (html) => {\n        let moduleName = html.find('#module-name')[0].value;\n        if (!moduleName) {\n          return;\n        }\n        game.settings.set(moduleName, 'imported', '0.0.0');\n        game.settings.set(moduleName, 'prompted', '0.0.0');\n        game.settings.set(moduleName, 'showWelcomePrompts', true);\n        if (canvas?.scene?.getFlag(moduleName, 'imported')) {\n          canvas.scene.setFlag(moduleName, 'imported', '0.0.0')\n        }\n      },\n    },\n    cancel: {\n      icon: '<i class=\"fas fa-times\"></i>',\n      label: 'Cancel',\n    },\n  },\n});\nd.render(true);","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.8Ed2EtweXHL8UrPq"},"scene-packer":{"sourceId":"Macro.8Ed2EtweXHL8UrPq","hash":"721dc48dda91dc45c12a41dc18f1db88acc76a1f"}},"_id":"JvOKXZgp38w06Mf2"}
{"_id":"JwwBB2eRxUda4O0P","name":"Maul","type":"script","author":"NThiNDE0MDE3NTcx","img":"icons/weapons/maces/mace-spiked-wood-grey.webp","scope":"global","command":"game.dnd5e.rollItemMacro(\"Maul\");","folder":null,"sort":100001,"permission":{"default":0,"NThiNDE0MDE3NTcx":3},"flags":{"dnd5e":{"itemMacro":true}}}
{"_id":"KGwq1oWvCVOPqGhZ","name":"19 - T02 - Devouring Fire","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/fire.svg","scope":"global","command":"let params =\n[{\n    filterType: \"fire\",\n    filterId: \"myFire\",\n    intensity: 3,\n    color: 0xFFFFFF,\n    amplitude: 2,\n    time: 0,\n    blend: 10,\n    fireBlend : 1,\n    alphaDiscard: true,\n    zOrder: 50,\n    animated :\n    {\n      time : \n      { \n        active: true, \n        speed: -0.0024, \n        animType: \"move\" \n      }\n    }\n},{\n    filterType: \"glow\",\n    filterId: \"glowripples\",\n    outerStrength: 4,\n    innerStrength: 2,\n    color: 0xAA6500,\n    quality: 0.5,\n    padding: 10,\n    zOrder: 100,\n}];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.world.token-magic-dev.Gec6BaJMehMO7p7v"},"scene-packer":{"hash":"90e9681ab74df351ba725e4e3a61aca4f37ac752"},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"KMzsTfwtzAPpWwY5","name":"New Macro","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 2d20","author":"NGIwMDczNDc3YmVi","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Show scene performance report","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/upgrade.svg","scope":"global","command":"// This macro shows a performance report that details the\n// complexity in a Scene. It can be used as a guide to help\n// determine how a Scene may perform for players.\n\nScenePacker.ShowPerformanceReport();","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.frlsbESCLKNBjrYG"},"scene-packer":{"hash":"6af91c2949ec4d4a473b66f1fe278050ff43047c"}},"_id":"KTuZ20DU0HD81VFu"}
{"name":"Blindness/Deafness","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Blindness/Deafness\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/evil-eye-red-2.jpg","actorIds":[],"_id":"LGjscfFoqub1m6qS"}
{"name":"Lay On Hands","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/**\n * System: D&D5e\n * Apply lay-on-hands feat to a target character.  Asks the player how many HP to heal and\n * verifies the entered value is within range before marking down usage counter. If the player\n * has OWNER permissions of target (such as GM or self-heal) the HP are applied automatically; \n * otherwise, a 'roll' message appears allowing the target character to right-click to apply healing.\n */\n\n(async () => {\n\nconst layName = \"Lay on Hands\";\nlet confirmed = false;\nlet actorData = actor || canvas.tokens.controlled[0] || game.user.character;\nlet featData = actorData ? actorData.items.find(i => i.name===layName) : null;\n\nif(actorData == null || featData == null) \n    ui.notifications.warn(`Selected hero must have ${layName} feat.`);\nelse if (game.user.targets.size !== 1)\n    ui.notifications.warn(`Please target one token.`);\nelse\n{\n    let featUpdate = duplicate(featData);\n    let targetActor = game.user.targets.values().next().value.actor;\n    let maxHeal = Math.clamped(featUpdate.data.uses.value, 0, \n        targetActor.data.data.attributes.hp.max - targetActor.data.data.attributes.hp.value);\n\n    let content = `<p><em>${actorData.name} lays hands on ${targetActor.data.name}.</em></p>\n                    <p>How many HP do you want to restore to ${targetActor.data.name}?</p>\n                    <form>\n                        <div class=\"form-group\">\n                            <label for=\"num\">HP to Restore: (Max = ${maxHeal})</label>\n                            <input id=\"num\" name=\"num\" type=\"number\" min=\"0\" max=\"${maxHeal}\"></input>\n                        </div>\n                        <div class=\"form-group\">\n                            <label for=\"flavor\">Flavor:</label>\n                            <input id=\"flavor\" name=\"flavor\" value=\"${featUpdate.data.chatFlavor}\"></input>\n                        </div>\n                    </form>`;\n    new Dialog({\n        title: \"Lay on Hands Healing\",\n        content: content,      \n        buttons: {\n            heal: { label: \"Heal!\", callback: () => confirmed = true },\n            cancel: { label: \"Cancel\", callback: () => confirmed = false }\n        },\n        default: \"heal\",\n\n        close: html => {\n            (async () => {\n            if (confirmed) \n            {\n                let number = Math.floor(Number(html.find('#num')[0].value));\n                if (number < 1 || number > maxHeal)\n                    ui.notifications.warn(`Invalid number of charges entered = ${number}. Aborting action.`);\n                else\n                {\n                    let flavor = `<strong>${html.find('#flavor')[0].value}</strong><br>`;\n                    if (targetActor.permission !== CONST.ENTITY_PERMISSIONS.OWNER)\n                        // We need help applying the healing, so make a roll message for right-click convenience.\n                        new Roll(`${number}`).roll().toMessage({\n                            speaker: ChatMessage.getSpeaker(),\n                            flavor: `${actorData.name} lays hands on ${targetActor.data.name}.<br>${flavor}\n                            <p><em>Manually apply ${number} HP of healing to ${targetActor.data.name}</em></p>` });\n                    else {\n                        // We can apply healing automatically, so just show a normal chat message.\n                        ChatMessage.create({\n                            speaker: ChatMessage.getSpeaker(),\n                            content: `${actorData.name} lays hands on ${targetActor.data.name} for ${number} HP.<br>${flavor}`\n                        });\n                        await targetActor.update({\"data.attributes.hp.value\" : targetActor.data.data.attributes.hp.value + number});\n                    }\n                     \n                    //Update the value under \"Features\"\n                    featUpdate.data.uses.value = featUpdate.data.uses.value - number;\n                    await actorData.items.getName(layName).update({ \"data.uses.value\" : featUpdate.data.uses.value });\n\n                    //Update resource counter only if the \"Lay on Hands\" feature is set to consume it\n                    let resString = featUpdate.data.consume.target;\n                    if(resString.indexOf('resources') >= 0) {\n                       await actorData.update({\n                           data: { [featUpdate.data.consume.target] : featUpdate.data.uses.value }\n                       });\n                    }\n\n                    if (actorData.sheet.rendered) {\n                       // Update the actor sheet if it is currently open\n                       await actorData.render(true);\n                    }\n                };\n            }\n            })();\n        }\n    }).render(true);\n}\n})();","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.WhAe42txHIkeZk2s"},"scene-packer":{"hash":"9e94f4d80d6cc0e22548feb56cd34e0881257ce0"}},"_id":"Llmak3Wm1NtPTURA"}
{"_id":"MIZ0YShCEaYLS3a7","name":"1d20","permission":{"default":0,"YWVjYjMyYTc5OGJj":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20","author":"YWVjYjMyYTc5OGJj","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Detect Thoughts","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Detect Thoughts\");","author":"NGIwMDczNDc3YmVi","img":"systems/dnd5e/icons/spells/light-eerie-2.jpg","actorIds":[],"_id":"MiwLjObbT1jadeF3"}
{"name":"Thorn Whip","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Thorn Whip\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"N78NuTn1qVJhdZEb"}
{"name":"Reroll Bad D20 With Modifiers","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/**\n * Rolls a d20. If the roll is below a 3, it rerolls the value. Adds perception total + 1 as well.\n */\n\nlet dice = new Roll('1d20 + @skills.prc.total + 1').roll();\nif (dice.total <= (4 + actor.data.data.skills.prc.total)) dice.reroll();\ndice.toMessage();","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.REqPUjyUyd8xvnS5"},"scene-packer":{"hash":"41b8789e75d27622f1d409b6a4bff6ef5c989014"}},"_id":"OFYr8EiAJgfpvIe6"}
{"name":"27 - T02 - Glacial Aura (xglow)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"zapshadow\",\r\n    filterId: \"myGlacialZapShadow\",\r\n    alphaTolerance: 0.50\r\n},\r\n{\r\n    filterType: \"xglow\",\r\n    filterId: \"myGlacialAura\",\r\n    auraType: 1,\r\n    color: 0x5099DD,\r\n    thickness: 4.5,\r\n    scale: 3,\r\n    time: 0,\r\n    auraIntensity: 0.8,\r\n    subAuraIntensity: 0.25,\r\n    threshold: 0.5,\r\n    discard: false,\r\n    animated:\r\n    {\r\n        time : \r\n        {  \r\n           active: true,\r\n           speed: 0.0018, \r\n           animType: \"move\" \r\n        },\r\n        thickness:        \r\n        {\r\n           val1: 2, val2: 4.7,\r\n           animType: \"cosOscillation\",\r\n           loopDuration: 3000\r\n        },\r\n        subAuraIntensity:        \r\n        {\r\n           val1: 0.45, val2: 0.65,\r\n           animType: \"cosOscillation\",\r\n           loopDuration: 6000\r\n        },\r\n        auraIntensity:        \r\n        {\r\n           val1: 0.9, val2: 2.2,\r\n           animType: \"cosOscillation\",\r\n           loopDuration: 3000\r\n        }\r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.wdbgHdNcBwBETc1y"}},"_id":"OiOqxUqKieowl47A"}
{"_id":"PuKQudTTKwsK7W6t","name":"Chill Touch","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/ice-blue-1.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Chill Touch\");","folder":null,"sort":100001,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"QMwYQ9XPfO6fsMRg","name":"All Tokenâ€™s Passive Perception","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/octogonal-eye.svg","scope":"global","command":"// Pull the passive perception of each token in the current scene and whisper the results to the GM.\n// Only tested with the 5e System in Foundry.\n// Author: @Drunemeton#7955. Based on the original macro by author @Erogroth#7134.\n\n// Initalize variables.\nlet pcArray = [];\nlet npcArray = [];\nlet messageContentPC = \"\";\nlet messageContentNPC = \"\";\nlet messageHeaderPC = \"<b>PC Passive Perception</b><br>\";\nlet messageHeaderNPC = \"<b>NPC Passive Perception</b><br>\";\n\n// Gather tokens in the current scene into an array.\nlet tokens = canvas.tokens.placeables.filter((token) => token.data && token.actor);\n\n// From the tokens array sort into PC and NPC arrays.\nfor (let count of tokens) {\n  let tokenType = count.actor.data.type;\n  let tokenName = count.data.name;\n  let tokenPassive = count.actor.data.data.skills.prc.passive;\n  \n  if(tokenType === \"character\") {\n    pcArray.push({ name: tokenName, passive: tokenPassive });\n  } \n  if(tokenType === \"npc\") {\n    npcArray.push({ name: tokenName, passive: tokenPassive });\n  }\n}\n\n// Sort each array.\nsortArray(pcArray);\nsortArray(npcArray);\n\n// Build chat message, with PCs first, then NPCs.\nfor (let numPC of pcArray) {\n  messageContentPC += `${numPC.name}: <b>${numPC.passive}</b><br>`;\n}\nfor (let numNPC of npcArray) {\n  messageContentNPC += `${numNPC.name}: <b>${numNPC.passive}</b><br>`;\n}\n\nlet chatMessage = (messageHeaderPC + messageContentPC + `<br>` + messageHeaderNPC + messageContentNPC);\n\nlet chatData = {\n  user: game.user._id,\n  speaker: ChatMessage.getSpeaker(),\n  content: chatMessage,\n  whisper: game.users.filter((u) => u.isGM).map((u) => u._id),\n};\n\n// Display chat message.\nChatMessage.create(chatData, {});\n\n// Sort each array by Name.\n  function sortArray(checkArray) {\n    checkArray.sort(function (a, b) {\n      var nameA = a.name.toUpperCase(); // ignore upper and lowercase\n      var nameB = b.name.toUpperCase(); // ignore upper and lowercase\n      if (nameA < nameB) {\n        return -1;\n      }\n      if (nameA > nameB) {\n        return 1;\n      }\n      // names must be equal\n      return 0;\n    });\n\n    // Sort array by Passive Perception.\n    checkArray.sort(function (a, b) {\n      return b.passive - a.passive;\n    });\n  }","folder":null,"sort":0,"permission":{"default":0,"y5gmtwxmW3A5ZuOP":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.DBlk2wFOpxxhM9eC"},"combat-utility-belt":{"macroTrigger":""}}}
{"name":"Guidance","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// new build for guidance macro by Mr.White and Penguin#0949 and with no help all of Kotetsushin#7680 trust me \n// version beta 4.2.0\n\n// user notes\n// this macro is inteded for use by the recipient of the bless spell in D&D 5e on Forge VTT\n// N.B. every recipient will need to use this macro independantly on their own Actor/token.\n\n//user modifiable declarations CHANGE AT YOUR OWN RISK\nconst GuidIconPath = 'icons/svg/windmill.svg';\nlet GuideMsg = ' is guided!';\nlet endGuideMsg = ' is no longer guided.';\n\n//fixed declarations DO NOT MODIFY\nlet chatMsg = '';\nlet macroActor = token.actor;\nlet Guided = macroActor.effects.find(i => i.data.label === \"Guided\")\nlet Guide = {\n    changes: [\n        {\n            key: \"data.bonuses.abilities.check\",\n            mode: 2,\n            priority: 20,\n            value: \"+1d4\",\n        },\n    ],\n    duration: {\n        seconds: 60,\n    },\n    icon: GuidIconPath,\n    label: \"Guided\"\n}\n//identify token\nif (macroActor === undefined || macroActor === null) {\n    ui.notifications.warn(\"Please select a token first.\");\n}\nelse {\n// If already guided\t\n    if (Guided) {\n        macroActor.deleteEmbeddedDocuments(\"ActiveEffect\", [Guided.id]);\n        // anounce to chat\n        chatMsg = `${macroActor.name} ${endGuideMsg}`;\n    }\n    // if not already guided\t\n    else {\n        macroActor.createEmbeddedDocuments(\"ActiveEffect\", [Guide]);\n        // anounce to chat\n        chatMsg = `${macroActor.name} ${GuideMsg}`;\n    }\n    // write to chat if needed:\n    if (chatMsg !== '') {\n        let chatData = {\n            user: game.user._id,\n            speaker: ChatMessage.getSpeaker(),\n            content: chatMsg\n        };\n        ChatMessage.create(chatData, {});\n    }\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.GlWj7z7p2V4JKXMx"},"scene-packer":{"hash":"ee44a5e58d715f81a60d04dc48081523eb4546cb"}},"_id":"QiFCGSegXq63iG09"}
{"name":"Detect Magic","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Detect Magic\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/light-blue-2.jpg","actorIds":[],"_id":"RQVphXf0WnnpnXKv"}
{"_id":"RYx4H7FH7vnhaaqZ","name":"Unarmed Strike Attk","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{"combat-utility-belt":{"macroTrigger":""}},"scope":"global","command":"/r 1d20+7","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"33 - T04 - Some Real Nuts Here! (transform)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n    [{\r\n        filterType: \"transform\",\r\n        filterId: \"myTransform\",\r\n        padding: 200,\r\n        animated:\r\n        {\r\n            rotation:\r\n            {\r\n                clockWise: true,\r\n                loopDuration: 700,\r\n                animType: \"syncRotation\"\r\n            },\r\n            translationX:\r\n            {\r\n                animType: \"sinOscillation\",\r\n                val1: -0.25,\r\n                val2: +0.25\r\n            },\r\n            translationY:\r\n            {\r\n                animType: \"sinOscillation\",\r\n                val1: -0.125,\r\n                val2: +0.125,\r\n                loopDuration: 1500\r\n            },\r\n            scaleX:\r\n            {\r\n                animType: \"sinOscillation\",\r\n                val1: 0.5,\r\n                val2: 2.6,\r\n                loopDuration: 1200\r\n            },\r\n            scaleY:\r\n            {\r\n                animType: \"sinOscillation\",\r\n                val1: 0.5,\r\n                val2: 2.6,\r\n                loopDuration: 1200\r\n            }\r\n        }\r\n    }];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Compendium.tokenmagic.tmMacros.PHe9kakKlPKpARvm"}},"_id":"S3ZKrlHJZMqI9XJT"}
{"name":"Fire Bolt","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Fire Bolt\");","author":"NGIwMDczNDc3YmVi","img":"systems/dnd5e/icons/spells/fireball-red-1.jpg","actorIds":[],"_id":"S3cmS5KBNYavo3Gw"}
{"name":"Halo of Spores","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Halo of Spores\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"S47DqDyHsjiwdwGf"}
{"name":"Shillelagh","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Shillelagh\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/enchant-jade-1.jpg","actorIds":[],"_id":"S636MKRBEMbgF3YW"}
{"name":"Show Token Actions","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/*\n* Requires: DND5e.\n* Provides a dialog showing all action-triggered equipment, prepared and at-will spells, feats, and consumables,\n* as well as passive feats. Hopefully makes triggering actions easier without needing the character sheet open\n* all the time.\n* WARNING: Very ugly.\n* author/blame: ^ and stick#0520\n* with enormous help on the button events (and no blame to be attributed to): Skimble#8601\n*/\n\nclass ActionDialog extends Application {\n    super(options){\n    }\n\n    activateListeners(html) {\n        super.activateListeners(html);\n        const buttons = html.find(\"button[class='show-action-button']\");\n\n        if (buttons.length > 0)\n            buttons.on(\"click\", event => {this.openActionTab(event, html);});\n    }\n\n    openActionTab(event, html) {\n        // Declare all variables\n        var i, tabcontent, tablinks;\n\n        // Get all elements with class=\"tabcontent\" and hide them\n        tabcontent = document.getElementsByClassName(\"show-action-category\");\n        for (let t of tabcontent) {\n            t.style.display = \"none\";\n        }\n\n        // Get all elements with class=\"tablinks\" and remove the class \"active\"\n        tablinks = document.getElementsByClassName(\"show-action-button\");\n        for (let t of tablinks) {\n            t.className = t.className.replace(\" active\", \"\");\n        }\n\n        // Show the current tab, and add an \"active\" class to the button that opened the tab\n        if (event.target.value == \"showActionAll\") {\n            tabcontent = document.getElementsByClassName(\"show-action-category\");\n            for (let t of tabcontent) {\n                t.style.display= \"block\";\n            }\n        } else {\n            if (document.getElementById(event.target.value) != null)\n                document.getElementById(event.target.value).style.display = \"block\";\n        }\n        event.currentTarget.className += \" active\";\n    }\n\n    getData(){\n        // Get user's character or the first token from the controlled list.\n        function getTargetActor() {\n            const character = game.user.character;\n            if (character != null)\n                return character;\n\n            const controlled = canvas.tokens.controlled;\n\n            if (controlled.length === 0) return character || null;\n\n            if (controlled.length > 0 && controlled[0] != null) {\n                return controlled[0].actor;\n            }\n        }\n\n        function buildActionsList(targetActor) {\n            let equipped = targetActor.data.items.filter(i => i.type !=\"consumable\" && getProperty(i.data, \"data.equipped\"));\n            let activeEquipped = getActiveEquipment(equipped);\n            let weapons = activeEquipped.filter(i => i.type == \"weapon\");\n            let equipment = activeEquipped.filter(i => i.type == \"equipment\");\n\n            let other = activeEquipped.filter(i => i.type != \"weapon\" && i.type != \"equipment\");\n            let consumables = targetActor.data.items.filter(i => i.type == \"consumable\");\n            let items = { \"weapons\": weapons, \"equipment\": equipment, \"other\": other, \"consumables\": consumables };\n\n            let preparedSpells = targetActor.data.items.filter(i => i.type == \"spell\" && getProperty(i.data, \"data.preparation.prepared\"));\n            let spells = categoriseSpells(preparedSpells);\n\n            let allFeats = targetActor.data.items.filter(i => i.type == \"feat\");\n            let activeFeats = getActiveFeats(allFeats);\n            let passiveFeats =  getPassiveFeats(allFeats);\n            let feats = {\"active\": activeFeats, \"passive\": passiveFeats};\n\n\n            return { \"equipment\": items,\"spells\": spells, \"feats\": feats };\n        }\n\n        function getActiveEquipment(equipment) {\n            const activationTypes = Object.entries(game.dnd5e.config.abilityActivationTypes);\n\n            let activeEquipment = equipment.filter(e => {\n                if (getProperty(e.data, \"data.activation\") == undefined)\n                    return false;\n\n                for (let [key, value] of activationTypes) {\n                    if (getProperty(e.data, \"data.activation.type\") == key)\n                        return true;\n                }\n\n                return false;\n            });\n\n            return activeEquipment;\n        }\n\n        function categoriseSpells(spells) {\n            let powers = {};\n            let book = {}\n\n            book = spells.reduce(function (book, spell) {\n                var level = getProperty(spell.data, \"data.level\");\n                let prep = getProperty(spell.data, \"data.preparation.mode\");\n\n                const prepTypes = game.dnd5e.config.spellPreparationModes;\n                let prepType = prepTypes[prep];\n\n                if (prep == \"pact\" || prep == \"atwill\" || prep == \"innate\") {\n                    if (!powers.hasOwnProperty(prepType)) {\n                        powers[prepTypes[prep]] = [];\n                    }\n\n                    powers[prepType].push(spell);\n                } else {\n                    if (!book.hasOwnProperty(level)) {\n                        book[level] = [];\n                    }\n\n                    book[level].push(spell);\n                }\n\n                return book;\n            }, {});\n\n            return {\"book\": Object.entries(book), \"powers\": Object.entries(powers)};\n        }\n\n        function getActiveFeats(feats) {\n            const activationTypes = Object.entries(game.dnd5e.config.abilityActivationTypes);\n            let activeFeats = feats.filter(f => {\n                if (getProperty(f.data, \"data.activation\") == undefined)\n                    return false;\n\n                for (let [key, value] of activationTypes) {\n                    if (getProperty(f.data, \"data.activation.type\") == key)\n                        return true;\n                }\n\n                return false;\n            });\n\n            return Object.entries(activeFeats);\n        }\n\n        function getPassiveFeats(feats) {\n            const activationTypes = Object.entries(game.dnd5e.config.abilityActivationTypes);\n            let passiveFeats = feats.filter(f => {\n                if (getProperty(f.data, \"data.activation\") == undefined)\n                    return false;\n\n                for (let [key, value] of activationTypes) {\n                    if (getProperty(f.data, \"data.activation\") == key)\n                        return false;\n                }\n\n                return true;\n            });\n\n            return Object.entries(passiveFeats);\n        }\n\n        function getContentTemplate(actions) {\n            let template = `\n            <div>\n                 ${getCssStyle()}\n                <div class=\"show-action-form-group\">\n                    <div class=\"show-action-buttons\">\n                        <button value=\"showActionItems\" class=\"show-action-button\">Items</button>\n                        <button value=\"showActionSpells\" class=\"show-action-button\">Spells</button>\n                        <button value=\"showActionFeats\" class=\"show-action-button\">Feats</button>\n                        <button value=\"showActionAll\" class=\"show-action-button\">Show all</button>\n                    </div>\n                    </div>\n                    <div class=\"show-action-categories\">\n                        <div id=\"showActionItems\" class=\"show-action-category\">\n                            ${getItemsTemplate(actions.equipment)}\n                        </div>\n                        <div id=\"showActionSpells\" class=\"show-action-category\">\n                            ${getSpellsTemplate(actions.spells)}\n                        <div id=\"showActionFeats\" class=\"show-action-category\">\n                            ${getFeatsTemplate(actions.feats)}\n                        </div>\n                    </div>\n                </div>\n            </div>`;\n\n            return template;\n        }\n\n        // Gets a template of abilities or skills, based on the type of check chosen.\n        function getItemsTemplate(items) {\n            if (items.weapons.length + items.equipment.length + items.other.length + items.consumables.length === 0)\n                return \"\";\n\n            let template = `<div id=\"actionItems\" class=\"show-action-tabcontent\">\n                                <div class=\"show-action-tabcontent-title\">Items</div>\n                                    ${getItemsCategoryTemplate(\"Weapons\", items.weapons)}\n                                    ${getItemsCategoryTemplate(\"Equipment\", items.equipment)}\n                                    ${getItemsCategoryTemplate(\"Other\", items.other)}\n                                    ${getItemsCategoryTemplate(\"Consumables\", items.consumables)}\n                                </div>\n                            </div>`;\n\n            return template;\n        }\n\n        function getSpellsTemplate(spells) {\n            let template = `<div id=\"actionSpells\" class=\"show-action-tabcontent\">\n                                <div class=\"show-action-tabcontent-title\">Spells</div>\n                                    ${getSpellsCategoryTemplate(spells.powers)}\n                                    ${getSpellsCategoryTemplate(spells.book)}\n                                </div>\n                            </div>`;\n\n            return template;\n        }\n\n        function getFeatsTemplate(feats) {\n            if (feats.active.length + feats.passive.length === 0)\n                return \"\";\n\n            let template = `<div id=\"actionFeats\" class=\"show-action-tabcontent\">\n                                <div class=\"show-action-tabcontent-title\">Feats</div>\n                                    ${getFeatsCategoryTemplate(\"Active\", feats.active)}\n                                    ${getFeatsCategoryTemplate(\"Passive\", feats.passive)}\n                                </div>\n                            </div>`;\n\n            return template;\n        }\n\n        function getItemsCategoryTemplate(title, items) {\n            if (items.length === 0)\n                return \"\";\n\n            let template = `<div class=\"show-action-tabcontent-subtitle\">${title}</div>\n                            <div class=\"show-action-tabcontent-actions\">`;\n            for (let i of items) {\n                template += `<input id=\"weapon-${i.name}\" type=\"button\" value=\"${i.name}\" onclick=\"${getRollItemMacro(i.name)}\"/>`;\n            }\n\n            template += `</div>`;\n\n            return template;\n        }\n\n        function getSpellsCategoryTemplate(spells) {\n            if (spells.length === 0)\n                return \"\";\n\n            let template = \"\";\n\n            for (let [level, entries] of spells) {\n                console.log(!isNaN(level.toString()));\n                let subtitle = isNaN(level) ? level : (level.toString() === '0' ? `Cantrips` : `Level ${level}`);\n\n                template += `<div class=\"show-action-tabcontent-subtitle\">${subtitle}</div>\n                                <div class=\"show-action-tabcontent-actions\">`;\n\n                for (let s of entries) {\n                    template += `<input id=\"spell-${s.name}\" type=\"button\" value=\"${s.name}\" onclick=\"${getRollItemMacro(s.name)}\"/>`;\n                }\n\n                template += `</div>`;\n            }\n\n            return template;\n        }\n\n        function getFeatsCategoryTemplate(subtitle, feats) {\n            if (feats.length === 0)\n                return \"\";\n\n            let template = `<div class=\"show-action-tabcontent-subtitle\">${subtitle}</div>\n                            <div class=\"show-action-tabcontent-actions\">`\n\n            for (let [index, f] of feats) {\n                template += `<input id=\"feat-${f.name}\" type=\"button\" value=\"${f.name}\" onclick=\"${getRollItemMacro(f.name)}\"/>`;\n            }\n\n            template += `</div>`\n\n\n            return template;\n        }\n\n        function getCssStyle() {\n            return `\n            <style type=\"text/css\">\n            .show-action-buttons {\n                display: grid;\n                grid-template-columns: repeat(5, 1fr);\n                grid-gap: 10px;\n            }\n\n            .show-action-buttons button {\n                width: auto;\n                height: auto;\n                background-color: #eee;\n                float: left;\n                border: none;\n                outline: none;\n                cursor: pointer;\n                padding: 5px 8px;\n                transition: 0.3s;\n                display: block;\n              }\n                            \n              /* Change background color of buttons on hover */\n              .show-action-buttons button:hover {\n                background-color: #ddd;\n              }\n              \n              /* Create an active/current tablink class */\n              .show-action-buttons button.active {\n                background-color: #ccc;\n              }\n\n              .show-action-categories {\n                clear: both;\n              }\n              \n              /* Style the tab content */\n              .show-action-tabcontent {\n                display: block;\n                padding: 6px 12px;\n                border: 1px solid #ccc;\n                border-bottom: none;\n                border-left: none;\n                border-right: none;\n              }\n\n              .show-action-tabcontent-title {\n                    clear: both;\n                    font-size: large;\n              }\n\n              .show-action-tabcontent-subtitle {\n                  padding: 5px;\n                  margin: 2px;\n                  float: left;\n              }\n\n              .show-action-tabcontent input {\n                border: 1px solid #555;\n                padding: 5px;\n                margin: 2px;\n              }\n              \n              .show-action-tabcontent input:hover {\n              background-color: #ddd;\n              }\n            </style>`\n        }\n\n        function getRollItemMacro(itemName) {\n            return `game.dnd5e.rollItemMacro(&quot;${itemName}&quot;)`;\n        }\n\n        // set this to true if you want results whispered to the GM\n        let targetActor = getTargetActor();\n        let innerContent = \"\";\n\n        if (targetActor != null || targetActor) {\n            this.options.title = `${targetActor.name} actions`;\n            let actionLists = buildActionsList(targetActor);\n            innerContent = getContentTemplate(actionLists);\n        } else {\n            ui.notifications.error(\"No token selected or user character found.\");\n            throw new Error(\"No token selected or character found\");\n        }\n\n        var content =  `<div id=\"actionDialog\">${innerContent}</div>`;\n        var contentsObject = {content:`${content}`}\n        return contentsObject;\n    }\n}\n\nlet opt=Dialog.defaultOptions;\nopt.resizable=true;\nopt.title=\"Choose action\";\nopt.minimizable=true;\nopt.width=600;\nvar viewer;\nviewer = new ActionDialog(opt);\nviewer.render(true);","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.sjMYdsr3UapvE20H"},"scene-packer":{"hash":"3fcd7dbc53e6402adea65ae8f59329c6ea8bd950"}},"_id":"SO927oxy3NaaMQsI"}
{"name":"Random Mockeries","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Courtesy of @Zarek\n// Selected target receives a random mockery from a table called \"mockeries\" along with the DC and damage.\n// You can find a table called mockeries in the community tables module.\n\n\nlet tableName = \"mockeries\";\n// default mockery if no table found.\nlet mockery = \"Now go away or I shall taunt you a second time-a!\";\n\nlet viciousMockeries = async () => {\n  if (!actor) {\n    ui.notifications.warn(\"You must have an actor selected.\");\n    return\n  }\n\n  let actorLevels = actor.data.data.levels || 1;\n  let table = game.tables.contents.find(t => t.name == tableName);\n\n  // Get Targets name\n  const targetId = game.user.targets.ids[0];\n  const targetToken = canvas.tokens.get(targetId);\n  if (!targetToken) {\n    ui.notifications.warn(\"You must target a token.\");\n    return\n  }\n  const targetName = targetToken.name;\n\n  // Roll the result, and mark it drawn\n  if (table) {\n    if (checkTable(table)) {\n      let roll = await table.roll();\n      let result = roll.results[0];\n      mockery = result.data.text;\n      await table.updateEmbeddedDocuments(\"TableResult\", [{\n        _id: result.id,\n        drawn: true\n      }]);\n    }\n  }\n\n  function checkTable(table) {\n    let results = 0;\n    for (let data of table.data.results) {\n      if (!data.drawn) {\n        results++;\n      }\n    }\n    if (results < 1) {\n      table.reset();\n      ui.notifications.notify(\"Table Reset\")\n      return false\n    }\n    return true\n  }\n\n  // Add a message with damage roll\n  let numDie = 1;\n  if (actorLevels >= 17) {\n    numDie = 4;\n  } else if (actorLevels >= 11) {\n    numDie = 3;\n  } else if (actorLevels >= 5) {\n    numDie = 2;\n  }\n\n  let messageContent = `<p>${targetName} Roll WIS save DC [[8+${actor.data.data.abilities.cha.mod}+@attributes.prof]] or take [[${numDie}d4]] damage and have disadvantage.</p>`\n  messageContent += `<p>${token.name} exclaims <b><i>\"${mockery}\"</i></b></p>`\n  messageContent += `<details closed=\"\"><summary><a>Vicious Mockery</a></summary><p>You unleash a string of insults laced with subtle enchantments at a creature you can see within range. If the target can hear you (though it need not understand you), it must succeed on a <strong>Wisdom saving throw</strong> or take <strong>1d4 psychic damage</strong> and have <strong>disadvantage on the next attack roll</strong> it makes before the end of its next turn.</p>\n    <p>This spellâ€™s damage increases by 1d4 when you reach 5th level ([[/r 2d4]]), 11th level ([[/r 3d4]]), and 17th level ([[/r 4d4]]).</p></details>`\n\n  // create the message\n  if (messageContent !== '') {\n    let chatData = {\n      user: game.user.id,\n      speaker: ChatMessage.getSpeaker(),\n      content: messageContent,\n    };\n    ChatMessage.create(chatData, {});\n  }\n};\n\nviciousMockeries();","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.bUEeDjvYU5xEtZAr"},"scene-packer":{"hash":"7cf0a61bf9552388bbe18e22f00612221c89be6a"}},"_id":"SrPaiomeqLyjbSVE"}
{"name":"Fireball","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Fireball\");","author":"NGIwMDczNDc3YmVi","img":"systems/dnd5e/icons/spells/fireball-red-2.jpg","actorIds":[],"_id":"V0TNFXZEUXvzXlYj"}
{"name":"24 - T04 - Shell - Earth","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"field\",\r\n    filterId: \"myEarthField\",\r\n    shieldType: 4,\r\n    gridPadding: 2,\r\n    color: 0xBB9070,\r\n    time: 0,\r\n    blend: 1,\r\n    intensity: 1.25,\r\n    lightAlpha: 1,\r\n    lightSize: 0.7,\r\n    scale: 1,\r\n    radius: 1,\r\n    chromatic: false,\r\n    animated :\r\n    {\r\n      time : \r\n      { \r\n        active: true, \r\n        speed: 0.0015, \r\n        animType: \"move\" \r\n      }\r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.359Mw23cvaEDevkP"},"scene-packer":{"hash":"37f2711be595977acc504d75b4197ff2b801c05e"}},"_id":"V1spD404oPhFE1Kh"}
{"name":"Animal Friendship","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/wild-jade-2.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Animal Friendship\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"V3iatmMKZqDOmag6"}
{"name":"Burning Hands","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Burning Hands\");","author":"NGIwMDczNDc3YmVi","img":"systems/dnd5e/icons/spells/fog-orange-2.jpg","actorIds":[],"_id":"V7BusEM0lPVjOmJ4"}
{"_id":"VCfYBZETkMG65tmL","name":"18 - Electric","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/lightning-storm.svg","scope":"global","command":"// Because the shader is dynamically compiled,\n// intensity is a one time init and can't be updated.\n// you must delete the filters to \"change\" it.\nlet params =\n[{\n    filterType: \"electric\",\n    filterId: \"myElectric\",\n    color: 0xFFFFFF,\n    time: 0,\n    blend: 1,\n    intensity: 5,\n    animated :\n    {\n      time : \n      { \n        active: true, \n        speed: 0.0020, \n        animType: \"move\" \n      }\n    }\n}];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Compendium.tokenmagic.tmMacros.YJjeB7N0L1rGfZD2"},"combat-utility-belt":{"macroTrigger":""}}}
{"name":"Initiative With Disadvantage","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Initiative with Disadvantage by Nulmas#9462\n// Thanks to Freeze#2689, vance#1935 and u/Azzu for the help.\n\n// This macro allows GMs and players to roll for Initiative with disadvantage when playing D&D 5e. Hopefully it won't be needed for long and the option for it will be added \n// to the system in a future release.\n\n// The macro will roll for all the selected tokens and add them to the combat if they aren't in it already. It will also check if you are using Dex as a tiebreaker and roll\n// accordingly.\n\n// BEWARE: If a token has already rolled for initiative and you use this macro with it selected, the new initiative will replace the old one. I considered changing this, but\n// decided it's worth keeping it this way in case a player or GM rolls for initiative without disadvantage by mistake.\n\n(async () => {\n    if (canvas.tokens.controlled.length === 0) return ui.notifications.error(\"Choose tokens to roll for\");\n    await canvas.tokens.toggleCombat();\n    let chosenTokens = canvas.tokens.controlled;\n    let tieBreakerCheck = game.settings.get(\"dnd5e\", \"initiativeDexTiebreaker\") ? 1 : 0; //Checks if Dex tiebreaker is being used\n    let initiatives = chosenTokens.map(t => {\n        let chosenActor = t.actor;\n        let advantage = chosenActor.getFlag(\"dnd5e\", \"initiativeAdv\") ? 1 : 0;\n        let init = chosenActor.data.data.attributes.init.total;\n        let tieBreaker = chosenActor.data.data.abilities.dex.value/100;\n        let roll = new Roll(`${2 - advantage}d20kl + ${init} + ${tieBreaker * tieBreakerCheck}`).roll({async: false});\n        roll.toMessage({speaker: ChatMessage.getSpeaker({token: t.document})});\n        let combatantId = t.combatant.id;\n        return{\n            _id: combatantId,\n            initiative: roll.total,\n        };\n    });\n    await game.combat.updateEmbeddedDocuments(\"Combatant\", initiatives);\n})();","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.vvUdCHKq60JcksaX"},"scene-packer":{"hash":"056241421767b1382e403b0d9c210813d463f73a"}},"_id":"VUvg8Dcce2sUPdVK"}
{"_id":"VhJ9IbOTvrXU58uw","name":"New Macro","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d4","author":"NGNjNjcwYTg1OTY5","img":"icons/png/d4.png","actorIds":[]}
{"_id":"VlzOkvQdKOecTSWB","name":"1d20","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20","author":"NGNjNjcwYTg1OTY5","img":"icons/png/dice-twenty-faces-twenty.png","actorIds":[]}
{"name":"Goodberry","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Goodberry\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/leaf-acid-1.jpg","actorIds":[],"_id":"W5HHjFfOXNfwxd8w"}
{"name":"Shape Water","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Shape Water\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"WBwtaq27bg0jPHjx"}
{"name":"Tool Proficiency","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/**\n * Grab a list of tools in the selected player's inventory, then all the user to make a roll on the tool.\n * Will take into consideration if the player is proficient in using the tool.\n */\n\n// get the first entry from the array of currently selected tokens. Works best/exclusively with one selected token\nconst target = canvas.tokens.controlled[0].actor;\n// get the abilities of the selected token for ease of access later\nconst { abilities } = target.data.data;\n// Only items set as \"tools\" will be included!\n// get all held and equipped Tools/Kits/Supplies. Might want to replace with /[tT]ools|[kK]it|[sS]upplies|[sS]et$/ if gaming sets should be included\nconst toolsInInventory = target.items.filter( item => item.name.match(/[tT]ools|[kK]it|[sS]upplies$/) && item.data.data.hasOwnProperty(\"proficient\"));\n// const toolProficiencies = target.data.data.traits.toolProf; // Tools have proficiency mod in the object under <item>.data.data.proficient. \nlet tool = undefined;\n\n// Choose ability mod dialog\nconst abilityDialog = (async () => {\n    let template = `\n    <div>\n        <div class=\"form-group\">\n            <label>Choose ability</label>\n            <select id=\"selectedAbility\">`\n    for (let ability in abilities) {\n        switch (ability) {\n            case \"str\":\n                abilities[ability].name = \"Strength\"\n                break;\n            case \"dex\":\n                abilities[ability].name = \"Dexterity\"\n                break;\n            case \"con\":\n                abilities[ability].name = \"Constitution\"\n                break;\n            case \"int\":\n                abilities[ability].name = \"Intelligence\"\n                break;\n            case \"wis\":\n                abilities[ability].name = \"Wisdom\"\n                break;\n            case \"cha\":\n                abilities[ability].name = \"Charisma\"\n                break;\n            default:\n                console.log(\"something went wrong\");\n        }\n        template += `<option value=\"${ability}\">${abilities[ability].name} (${abilities[ability].value})</option>`;\n    }\n    template += `</select>\n        </div>\n    </div>`\n\n\n    new Dialog({\n        title: tool.name,\n        content: template,\n        buttons: {\n            ok: {\n                icon: '<i class=\"fas fa-check\"></i>',\n                label: \"OK\",\n                callback: async (html) => {\n                    const selection = html.find(\"#selectedAbility\")[0].value;\n                    console.log(tool, target);\n                    let prof = tool.data.data.proficient * target.data.data.attributes.prof; // target might be half or doubly proficient. This will make sure it is accounted for\n\n                    let messageContent = `${target.name} rolled a <b>[[1d20+${abilities[selection].mod}(${abilities[selection].name})+${prof}(Proficiency)]]</b> for the ${tool.name} check.<br>`;\n                    let chatData = {\n                        user: game.user.id,\n                        speaker: ChatMessage.getSpeaker(),\n                        content: messageContent,\n                        // uncomment the line below to always whisper the roll to the GM\n                        // whisper: game.users.filter(u => u.isGM).map(u => u._id)\n                    };\n                    ChatMessage.create(chatData, {});\n               }\n            },\n            cancel: {\n                icon: '<i class=\"fas fa-times\"></i>',\n                label: 'Cancel'\n            }\n        },\n        default: \"cancel\"\n    }).render(true);\n})\n\n// Choose tool dialog\nif (toolsInInventory.length) {\n    (async () => {\n        let template = `\n        <div>\n            <div class=\"form-group\">\n                <label>Choose a tool</label>\n                <select id=\"selectedTool\">`\n        toolsInInventory.forEach( tempTool => {    \n            template += `<option value=\"${tempTool.name}\">${tempTool.name}</option>`;\n        });\n        template += `</select>\n            </div>\n        </div>`;\n\n        new Dialog({\n            title: 'Which tool?',\n            content: template,\n            buttons: {\n                ok: {\n                    icon: '<i class=\"fas fa-check\"></i>',\n                    label: \"OK\",\n                    callback: async (html) => {\n                        let selection = html.find(\"#selectedTool\")[0].value;\n                        tool = toolsInInventory.find( item => item.name === selection )\n                        abilityDialog();\n                   }\n                },\n                cancel: {\n                    icon: '<i class=\"fas fa-times\"></i>',\n                    label: 'Cancel'\n                }\n            },\n            default: \"cancel\"\n        }).render(true);\n    })()    \n}\n\nelse {\n    new Dialog({\n        title: 'No Tools!',\n        content: '<p>You don\\'t seem to have any tool with you.</p>',\n        buttons: {\n            ok: {\n                icon: '<i class=\"fas fa-check\"></i>',\n                label: \"OK\"\n            }\n        },\n        default: \"ok\"\n    }).render(true);\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.vwfOm1Z1kY4EZS1G"},"scene-packer":{"hash":"a5571f80c2a83d96814252a05414495209ba2cfe"}},"_id":"WKB6BQExALS9THwO"}
{"name":"Clean up #[CF_tempEntity] entries","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/acid.svg","scope":"global","command":"// Prompt to remove \"#[CF_tempEntity]\" items from the world,\n// in the case where they have been imported when the\n// Compendium Folders module is not active.\n\nlet cfTempEntity = '#[CF_tempEntity]';\nfor (const entity of [\n  {name: 'scenes', collection: game.scenes},\n  {name: 'actors', collection: game.actors},\n  {name: 'items', collection: game.items},\n  {name: 'journals', collection: game.journal},\n  {name: 'macros', collection: game.macros},\n  {name: 'playlists', collection: game.playlists},\n  {name: 'roll tables', collection: game.tables},\n]) {\n  const found = entity.collection.filter(e => e.name === cfTempEntity);\n  if (found.length) {\n    Dialog.confirm({\n      title: `Delete ${found.length} ${entity.name}?`,\n      content: `<p>Do you want to <strong>delete</strong> ${found.length} ${entity.name} with the name <code style=\"display:inline-block;\">${cfTempEntity}</code> from your world?</p>`,\n      yes: () => {\n        for (const foundElement of found) {\n          console.log(`Deleting ${foundElement.id} from ${entity.name}`);\n          const document = entity.collection.get(foundElement.id);\n          if (document) {\n            document.delete();\n          }\n        }\n      }\n    });\n  } else {\n    console.log(`No ${entity.name} with the name \"${cfTempEntity}\" found.`);\n  }\n}","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.Vseli28UPwE5waan"},"scene-packer":{"sourceId":"Macro.Vseli28UPwE5waan","hash":"d649b868613f82955a232ac8962151d7ea6f5dfa"}},"_id":"WgYplBKhYE5pkKnv"}
{"name":"Call Lightning","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Call Lightning\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/lighting-sky-2.jpg","actorIds":[],"_id":"XE7i5FPV8s5uEAEF"}
{"_id":"XEB606lZY8vPukd0","name":"Shillelagh Quarterstaff","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"icons/weapons/staves/staff-simple-gold.webp","scope":"global","command":"/r 1d20+6","folder":null,"sort":100001,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}}}
{"name":"Heat Metal","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/light-air-fire-3.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Heat Metal\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"XudMZ5QSPiiCUZJZ"}
{"name":"Bulk Lock/Unlock compendiums","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/door-locked-outline.svg","scope":"global","command":"// This macro allows you to bulk lock or unlock compendiums\n// as a way to save time.\n(() => {\n  if (!game.user.isGM) {\n    return;\n  }\n\n  let activeModules = game.data.modules\n    .filter((m) => m.active && m.packs?.length)\n    .map((m) => m.id);\n  if (!activeModules.length) {\n    ui.notifications.info(\n      \"There are no modules with compendium packs in this world.\"\n    );\n    return;\n  }\n  let hasWorldCompendiums = !!game.packs.find(p => p.metadata.package === 'world')\n  let content = `<p>Bulk Lock/Unlock compendium packs that belong to the following module:</p>`;\n  content += '<select id=\"module-name\">';\n  activeModules.forEach((m) => {\n    content += `<option value=\"${m}\">${m}</option>`;\n  });\n  if (hasWorldCompendiums) {\n    content += `<option value=\"world\">world</option>`;\n  }\n  content += \"</select>\";\n  content += \"<p><hr></p>\";\n  let d = new Dialog({\n    title: \"Bulk Lock/Unlock compendium packs\",\n    content: content,\n    buttons: {\n      lock: {\n        icon: '<i class=\"fas fa-lock\"></i>',\n        label: game.i18n.localize(\"Lock\"),\n        callback: async (html) => {\n          await setState(true, html.find(\"#module-name\")[0].value);\n        },\n      },\n      unlock: {\n        icon: '<i class=\"fas fa-unlock\"></i>',\n        label: game.i18n.localize(\"Unlock\"),\n        callback: async (html) => {\n          await setState(false, html.find(\"#module-name\")[0].value);\n        },\n      },\n      cancel: {\n        icon: '<i class=\"fas fa-times\"></i>',\n        label: game.i18n.localize(\"Cancel\"),\n      },\n    },\n  });\n  d.render(true);\n\n  async function setState(locked, moduleName) {\n    locked = !!locked;\n    const compendiums = game.packs.filter(\n      (p) => p.metadata.package === moduleName\n    );\n    const settings = {};\n    compendiums.forEach((p) => {\n      settings[`${p.metadata.package}.${p.metadata.name}`] = { locked };\n    });\n    if (Object.keys(settings).length) {\n      let key = locked\n                ? \"Locking compendiums: {list}\"\n                : \"Unlocking compendiums: {list}\";\n      ui.notifications.info(\n        game.i18n.format(key, {\n          list: Object.keys(settings).join(\", \"),\n          locked: locked,\n        })\n      );\n      let configSetting =\n        Compendium?.CONFIG_SETTING ||\n        CompendiumCollection?.CONFIG_SETTING ||\n        \"compendiumConfiguration\";\n      await game.settings.set(\"core\", configSetting, settings);\n    }\n  }\n})();","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"scene-packer":{"hash":"dcda238845287cc277e07c5e6c606031bbb2875a","sourceId":"Macro.cEYqc2chS1vOpIPo"},"core":{"sourceId":"Macro.cEYqc2chS1vOpIPo"}},"_id":"ZQV7yFClOMpsdFee"}
{"_id":"ZaCAEjntHRwu156R","name":"Spell Attack","permission":{"default":0,"YWVjYjMyYTc5OGJj":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20 + 4 + 2","author":"YWVjYjMyYTc5OGJj","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"aBR6oVHv2fYjlQPE","name":"New Macro","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d10","author":"NGNjNjcwYTg1OTY5","img":"icons/png/d10.png","actorIds":[]}
{"name":"Potion of Healing","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"icons/consumables/potions/potion-tube-corked-red.webp","scope":"global","command":"game.dnd5e.rollItemMacro(\"Potion of Healing\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"aCnFp3JA3PfVU0ix"}
{"name":"Bless","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// new build for bless macro by Penguin#0949 with help from Kotetsushin#7680\n// version beta 4.2.0\n\n// user notes\n// this macro is inteded for use by the recipient of the bless spell in D&D 5e on Forge VTT\n// N.B. every recipient will need to use this macro independantly on their own Actor/token.\n\n//user modifiable declarations CHANGE AT YOUR OWN RISK\nconst blessIconPath = 'icons/svg/regen.svg';\nlet blessMsg = ' is Blessed!';\nlet endblessMsg = ' is no longer Blessed';\n\n//fixed declarations DO NOT MODIFY\nlet macroActor = token.actor;\nlet chatMsg = '';\nlet Blessd = macroActor.effects.find(i => i.data.label === \"Blessed\")\nlet bless = {\n    changes: [\n        {\n            key: \"data.bonuses.mwak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"+1d4\",\n        },\n        {\n            key: \"data.bonuses.rwak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"+1d4\",\n        },\n\t\t{\n            key: \"data.bonuses.msak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"+1d4\",\n        },\n\t\t{\n            key: \"data.bonuses.rsak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"+1d4\",\n        },\n\t\t{\n            key: \"data.bonuses.abilities.save\",\n            mode: 2,\n            priority: 20,\n            value: \"+1d4\",\n        },\n    ],\n    duration: {\n        seconds: 60,\n    },\n    icon: blessIconPath,\n    label: \"Blessed\"\n}\n//identify token\nif (macroActor === undefined || macroActor === null) {\n  ui.notifications.warn(\"Please select a token first.\");\n} \nelse {\n// If already bless\t\nif (Blessd) {\n    macroActor.deleteEmbeddedDocuments(\"ActiveEffect\", [Blessd.id])\n// anounce to chat\n\tchatMsg = `${macroActor.name} ${endblessMsg}`;\n}\n// if not already bless\t\nelse {\n    macroActor.createEmbeddedDocuments(\"ActiveEffect\", [bless])\t\n// anounce to chat\n\t\tchatMsg = `${macroActor.name} ${blessMsg}`;\n}\n// write to chat if needed:\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n\t};\n\tChatMessage.create(chatData, {});\n}\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.50p0yXEpxXa9aAYJ"},"scene-packer":{"hash":"1b96394d854d3de0c1c2d70d9489d54c2e5a197f"}},"_id":"aDZUrDqHVMTOdT2Z"}
{"_id":"aMnIGWu2YiJcgzHh","name":"Bulk Unpack Scenes","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/up.svg","scope":"global","command":"// This macro will unpack any scenes in your world that have\n// packed data. It can be used to prevent you needing to go\n// through activating each scene one by one.\n(async () => {\n  ScenePacker.PromptForInstance().then(async instance => {\n    if (!instance?.moduleName) {\n      return;\n    }\n\n    const scenes = [];\n    for (const scene of game.scenes) {\n      if (ScenePacker.HasPackedData(scene, instance.moduleName)) {\n        scenes.push(scene);\n      }\n    }\n    if (!scenes.length) {\n      return ui.notifications.info(`There are no scenes that need unpacking in \\\"${instance.moduleName}\\\".`);\n    }\n\n    ui.notifications.info(`Unpacking ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n    console.log(`Unpacking ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n    for (const scene of scenes) {\n      await instance.ProcessScene(scene, {showLinkedJournal: false, showUI: false});\n    }\n    ui.notifications.info(`Done. Unpacked ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n    console.log(`Done. Unpacked ${scenes.length} scenes in \\\"${instance.moduleName}\\\".`);\n  });\n})();","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.cRYEZq7UjvUNZ8g5"},"scene-packer":{"sourceId":"Macro.cRYEZq7UjvUNZ8g5","hash":"bd0d6249ed5ef1512a317da03e5b690ffd174f90"},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"adQ2HLw2PZgzv6Ts","name":"Summon Beast Attack","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20 + 4 +2 # Summon Beast Attack","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Fighter Second Wind","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/**\n * Macro for the Second Wind feature of Fighter.\n * Works with an active Fighter actor, prints a ui error otherwise.\n *\n * Requires a \"Second Wind\" resource, and will decrement it automatically.\n * Prints a chat message, rolls the heal amount, and updates the actor sheet appropriately.\n *\n * Inspired largely by the rage macro for 5e by Norc#5108\n */\n\n// TODO: Add additional configuration options and overrides.\n\nlet fighter = \"\";\nlet chatMsg = \"\";\nlet macroActor = actor;\nlet macroToken = token;\n\nconst fighterClassName = \"Fighter\";\nconst secondWindResourceName = \"Second Wind\";\n\nconst secondWindMessage = \"takes a deep breath and heals for\";\n\nconst errorSelectFighter = \"Please select a single fighter token\";\nconst errorNoSecondWind =\n  \"does not have any second wind left, time for a rest!\";\n\n/**\n * Optional Resource Reduction\n */\nconst resourceDeduction = true;\nconst preventNegative = true;\n\nif (macroActor !== undefined && macroActor !== null) {\n  fighter = macroActor.items.find((i) => i.name === `${fighterClassName}`);\n  // Early error if not a fighter\n  if (fighter === undefined) errorMsg(errorSelectFighter);\n\n  // Logic if selected actor is a fighter\n  if (fighter !== undefined && fighter !== null) {\n    // Check for available second wind resource\n    if (checkResource(macroActor)) {\n      // Calculate string to roll based on fighter level\n      let fighterLvl = fighter.data.data.levels;\n      let healRoll = new Roll(`1d10 + ${fighterLvl}`).roll();\n\n      ChatMessage.create({\n        user: game.user._id,\n        speaker: ChatMessage.getSpeaker({\n          token: actor,\n        }),\n        content: `<em>${macroActor.name} ${secondWindMessage} <strong>${healRoll.total}<strong><em>`,\n      });\n\n      updateHP(macroActor, healRoll.total);\n    }\n  }\n}\n\n/**\n * Updates the hp value of the actor sheet\n *\n * @param {Actor} actor active actor calling the macro\n * @param {Number} amt amount to add to current hp\n * @return {Number} actor sheet current hp value\n */\nfunction updateHP(actor, amt) {\n  let { attributes } = actor.data.data;\n  let cur_hp = attributes.hp.value;\n  let max_hp = attributes.hp.max;\n  let min_hp = attributes.hp.min;\n\n  cur_hp = Math.min(cur_hp + amt, max_hp);\n  cur_hp = Math.max(cur_hp, min_hp);\n  actor.update({\n    \"data.attributes.hp.value\": parseInt(cur_hp),\n  });\n  return cur_hp;\n}\n\n/**\n * Checks the resource of the actor sheet\n *\n * @param {Actor} actor active actor calling the macro\n * @return {Boolean} true if resource available or deduction disabled, false otherwise\n */\nfunction checkResource(actor) {\n  if (resourceDeduction) {\n    const { resources } = actor.data.data;\n    let hasResource = false;\n    let newResources = duplicate(resources);\n    let obj = {};\n    // Look for resources under core actor data\n    let resourceKey = Object.keys(resources)\n      .filter((key) => resources[key].label === `${secondWindResourceName}`)\n      .shift();\n    if ((resourceKey && resources[resourceKey].value > 0) || !preventNegative) {\n      hasResource = true;\n      newResources[resourceKey].value--;\n      obj[\"data.resources\"] = newResources;\n      actor.update(obj);\n      return true;\n    }\n    if (!hasResource) {\n      ui.notifications.error(`${actor.name} ${errorNoSecondWind}`);\n      return false;\n    }\n  }\n  return true;\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.jm7QjDGeMrkhLrLQ"},"scene-packer":{"hash":"ac7ba381c819421a938b9e585ab3eb71265ea5a8"}},"_id":"apDQD0ggsraExQew"}
{"name":"Sharpshooter","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"if (!Boolean(actor)) return ui.notifications.warn(\"Please select a token.\");\nif (!Boolean(actor.items.find(i => i.name === 'Sharpshooter'))) return ui.notifications.warn(\"Please select a single token with the Sharpshooter feat.\");\n\nlet atkModifier = -5;\nlet dmgModifier = 10;\nconst isEnabled = Boolean(actor.data.flags.ssMacro?.isEnabled);\n\nconst disableSharpshooter = (item) => item.update({\n    'data.damage.parts': item.data.flags.ssMacro.oldDmg,\n    'data.attackBonus': item.data.flags.ssMacro.oldAtk ?? 0,\n    'flags.ssMacro': null\n});\n\nconst enableSharpshooter = (item) => {\n    let oldDmg = JSON.parse(JSON.stringify(item.data.data.damage.parts));\n    item.data.data.damage.parts[0][0] = `${item.data.data.damage.parts[0][0]} + ${dmgModifier}`;\n\n    item.update({\n        'flags.ssMacro.oldDmg': oldDmg,\n        'flags.ssMacro.oldAtk': JSON.parse(JSON.stringify(item.data.data.attackBonus ?? 0)),\n        'data.damage.parts': item.data.data.damage.parts,\n        'data.attackBonus': `${+(item.data.data.attackBonus || 0) + atkModifier}`\n    });\n}\n\nactor.update({ 'flags.ssMacro.isEnabled': !isEnabled });\nfor (let item of actor.items) {\n    let isRangedWeapon = getProperty(item, 'data.data.actionType') === 'rwak' && getProperty(item, 'data.type') === 'weapon';\n\n    if (isRangedWeapon && item.data.data.damage.parts.length > 0)\n        isEnabled ? disableSharpshooter(item) : enableSharpshooter(item);\n}\n\nChatMessage.create({\n    user: game.user._id,\n    speaker: ChatMessage.getSpeaker(),\n    content: isEnabled ? `${actor.name} is aiming normally now.` : `${actor.name} is aiming for vital areas.`,\n}, {});","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.gKnoce2uTbOT9FBe"},"scene-packer":{"hash":"6b19ca4ace4947803f6d9fd1f086414f8ee678c5"}},"_id":"cBAXuzIW2l11cCPu"}
{"_id":"clNxmo8rYv3B6iOD","name":"New Macro","permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d12","author":"NGNjNjcwYTg1OTY5","img":"icons/png/d12.png","actorIds":[]}
{"name":"24 - T04 - Shell - Earth","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"field\",\r\n    filterId: \"myEarthField\",\r\n    shieldType: 4,\r\n    gridPadding: 2,\r\n    color: 0xBB9070,\r\n    time: 0,\r\n    blend: 1,\r\n    intensity: 1.25,\r\n    lightAlpha: 1,\r\n    lightSize: 0.7,\r\n    scale: 1,\r\n    radius: 1,\r\n    chromatic: false,\r\n    animated :\r\n    {\r\n      time : \r\n      { \r\n        active: true, \r\n        speed: 0.0015, \r\n        animType: \"move\" \r\n      }\r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.359Mw23cvaEDevkP"}},"_id":"d1wUcufTdacA5HAA"}
{"name":"Heavy Armor Feat Workaround","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"//Crude but effective way to simulate Heavy Armor Master.\n//Every time the player takes eligible damage, they can just click this macro with their token selected to \"get their 3HP back.\"\n//Questions? Ask in #macro-polo on Discord. If absolutely needed, please ping Norc#5108.\n\n//Known minor limitation: Does not take into account temp HP AT ALL.\n\nfunction modifyHP(token, amount) {\n    let hp_cur = token.actor.data.data.attributes.hp.value;\n    let hp_max = token.actor.data.data.attributes.hp.max;\n    let hp_min = token.actor.data.data.attributes.hp.min;\n    hp_cur = (hp_cur+amount > hp_max) ? hp_max : hp_cur+amount;\n    hp_cur = (hp_cur < hp_min) ? hp_min : hp_cur;\n    token.actor.update({'data.attributes.hp.value': parseInt(hp_cur)});\n    return hp_cur;\n  }\n\nif(token) {\n    //Note: Just change the number after the comma to heal/receive other HP values. Negative numbers indicate damage.\n    modifyHP(token,3);\n} else {\n    ui.notifications.notify(\"Please select a token.\");\n}6","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.Tbg9DhQqgQQZdMGZ"},"scene-packer":{"hash":"d889c193562dd17ca190c9c5db6074977be92401"}},"_id":"dH2PpVe99MhOQzWI"}
{"name":"Mage Armor","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Mage Armor\");","author":"NGIwMDczNDc3YmVi","img":"systems/dnd5e/icons/spells/protect-blue-1.jpg","actorIds":[],"_id":"dtn2B3FBpO0YmPnr"}
{"_id":"eFjE3I3S9q8sCHnP","name":"25 - T02 - Lucky Clover (xray)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/thorny-vine.svg","scope":"global","command":"let params =\n[{\n    filterType: \"xray\",\n    filterId: \"myLuckyRays\",\n    time: 0,\n    color: 0x00FF00,\n    blend: 9,\n    dimX: 0.05,\n    dimY: 0.05,\n    anchorX: 0.5,\n    anchorY: 0.5,\n    divisor: 4,\n    intensity: 1,\n    animated :\n    {\n       time : \n       { \n          active: true, \n          speed: 0.0012, \n          animType: \"move\" \n       },\n       anchorX:\n       {\n          animType: \"syncCosOscillation\",\n          loopDuration : 6000,\n          val1: 0.40,\n          val2: 0.60\n       },\n       anchorY:\n       {\n          animType: \"syncSinOscillation\",\n          loopDuration : 6000,\n          val1: 0.40,\n          val2: 0.60\n       }\n    }\n}];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.YPOoPH63FqcEoVTk"},"scene-packer":{"hash":"f4327c67c979a1237d0b498dd45a1635234fa377"},"combat-utility-belt":{"macroTrigger":""}}}
{"name":"Rage","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"//\t\tDISCLAIMER:\t\tThis macro is an evolved version of the original D&D 5e Rage Macro masterwork written by Felix#6196.\n//\t\t\t\t\t\tNorc#5108 is now maintaining this macro along with continued support from Felix.\n//\n//\n//\t\tUPDATES:\t\t1.\tFixed errors resulting from declarations of \"actor\" and \"token\" in a script macro. \n//\t\t\t\t\t\t\tAdded automatic Totem Spirit: Bear detection and resistance application \n//\t\t\t\t\t\t\tAdded error messages for trying to rage with no token or no barbarian selected\n//\t\t\t\t\t\t2.\t(Felix) Added resource/usage deduction and errors (re-added after accidentally overwriting the addition)\n//\t\t\t\t\t\t\tFixed rage damage at level 8\n//\t\t\t\t\t\t3.\t(2020/05/30) \"Version 2.0\" \t\n//\t\t\t\t\t\t\tImplemented Felix's idea to use global melee weapon attack bonus instead of modifying items\n//\t\t\t\t\t\t\tImproved Rage icon toggling to be more reliable\n//\t\t\t\t\t\t\tRemoved code from the resource management that created dependency on The Furnace Advanced Macros\n//\t\t\t\t\t\t\tImplemented Felix's fix for issue where new resistances and rage uses were not saving properly\n//\t\t\t\t\t\t\tFixed rage damage formula again...\n//\t\t\t\t\t\t\tAdded basic support for non-strength Based barbarians (Dex, Hexblade)\n//\t\t\t\t\t\t\tAdded optional ability to toggle the icon and name of the macro itself based on current raging state.\n//\t\t\t\t\t\t4.\t(2020/06/04) \n//\t\t\t\t\t\t\tFixed bug with experimental macro name/icon toggle only by renaming \"actor\" and \"token\"\n//\t\t\t\t\t\t\tAdded basic localization support to allow searching for translated class features\n//\t\t\t\t\t\t5.\t(2020/06/10)\n//\t\t\t\t\t\t\tRework to rage damage logic under the hood for edge case (other changes to bonus damage mid-combat) \n//\t\t\t\t\t\t\tRemoved logic that was causing multiple character sheets to open in some cases\n//\t\t\t\t\t\t\tEnhanced localization support\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!   Bonus Tip 1: \t\tOptional Rage Resource Consumption\n//!!!\tTo automatically use and track Rage, you must have a resource exactly named \"Rage\" on your character sheet. This text can be changed\n//!!!\tby altering the value for \"rageResourceName\" in the LOCALIZATION SUPPORT section below).\n//!!!\tNote: \tImporting via VTTA Beyond Integration uses this text already. The macro can then automatically detect the Rage resource.\n//!!!\n//!!!\tBonus Tip 2: \t\tBear Totem Spirit Barbs\n//!!!\tIf you chose the Spirit Seeker Primal path, and at level 3 you chose the Bear Totem Spirit (resistance to all non-psychic damage), \n//!!!\tin your 5E character sheet, double-check that the name of your Totem Spirit feature to EXACTLY \"Totem Spirit: Bear\". This text can be\n//!!!\tchanged by altering the value for \"bearTotemFeatureName\" in the LOCALIZATION SUPPORT section below).\n//!!!\tNote: \tImporting via VTTA Beyond Integration uses this text already. The macro then automatically adds the extra \n//!!!\t\t\tBear Totem Spirit resistances.\n//!!!\n//!!!\tBonus Tip 3: \t\tThrown Weapons\n//!!!\tWhen a barb throws a weapon using strength, typically a javelin but also possibly a dagger, dart, sword, bar table etc, the rage bonus\n//!!!\tshould not be added because it is a ranged attack. However, D&D5E calls javelins and daggers Melee Weapons, because technically they\n//!!!\tare both. To solve this issue, if you always throw the weapon, click the weapon's details and change the attack type to \"Ranged Weapon\n//!!!\tAttack\" in the Action Type dropdown. If you want, you can add a second copy of the item (with no weight/quantity) to use for meleeing.\n//!!!\n//!!!\tBonus Tip 4: \t\tThe Rage Condition\n//!!!\tIf you use the Combat Utility Belt module's Condition Lab, try adding a condition called \"Raging\" with the same icon\n//!!!\tas the optional rage icon overlay, 'icons/svg/explosion.svg' by default.  See EXPERIMENTAL MACRO ICON/NAME TOGGLE section below.\n//!!!\n//!!!\tBonus Tip 5: \t\tObsidian Sheet Compatibility\n//!!!\tIf using Obsidian module, try replacing \"Barbarian\" with \"brb\" as the barbClassName value in LOCALIZATION SUPPORT below.\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL TOKEN ICON-\tOn by default. If a path to a rage icon is defined, it displays like a condition on the raging barbarian.\n//!!!\t\t\t\t\t\t\tTo use a different icon, manually change the filepath below or leave it empty ('') to disable the effect.\n//!!!\nconst rageIconPath = 'icons/svg/explosion.svg';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL RESOURCE DEDUCTION \tOn by default. First option automatically subtracts from the Rage Resource if enabled.\n//!!!\t\t\t\t\t\t\t\t\tSecond option prevents raging if no Rage resource is left. Set to false if you do not want this.\n\n\t\t\tconst deductResource = true;\n\t\t\tconst preventNegativeResource = true;\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tOPTIONAL NON-STRENGTH BARBARIAN SUPPORT\t\tONLY override to FALSE if your barbarian does not use Strength to make melee attacks\n//!!!\t\t\t\t\t\t\t\t\t\t\t\tand therefore does not get the Rage bonus to melee weapon attack damage.\n//!!!\n\t\t\tconst strAttacks = true;\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tEXPERIMENTAL MACRO ICON/NAME TOGGLE\t\tIf enabled, the macro icon and name toggles based on the barbarian's rage state.\n//!!!\t\t\t\t\t\t\t\t\t\t\tCAUTIONS: \t1. \tThis feature is off by default and is intended for ADVANCED USERS ONLY.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t2. \tRequires configuration using \"The Furnace\" module for a player to run!\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tThe GM needs to grant The Furnace's \"Run as GM\" permission for this macro.\n//!!!\t\t\t\t\t\t\t\t\t\t\t\t\t\t3. \tWorks best with only one barbarian using this feature at a time.\n\n\t\t\t//To auto-toggle the macro's icon/name, override toggleMacro to true below.\n\t\t\tconst toggleMacro = false;\n\n\t\t\t//To use a different icon, manually change the filepath here\n\t\t\tconst stopRageIconPath = 'icons/svg/unconscious.svg';\n\n\t\t\t//You must update the following constant to this macro's exact name for the macro icon toggling to work.\n\t\t\tconst rageMacroName = 'Rage';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n//declarations\nlet barb = '';\nlet chatMsg = '';\nlet bear = '';\nlet noRage = false;\nlet rageDmgAdded = false;\nlet toggleResult = false;\nlet macroActor = actor;\nlet macroToken = token;\n\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n//!!!\tLOCALIZATION SUPPORT\t\t\t\tSets names of D&D5E features as constants instead of hardcoding to allow easier translation.\n//!!!\t\t\t\t\t\t\t\t\t\tSets error messages and flavor text as constants also for easier translation.\n//!!!\n\t\t\t//MUST MATCH VALUES IN CHARACTER SHEET (if present)\n\t\t\tconst barbClassName = 'Barbarian';\n\t\t\tconst rageResourceName = 'Rage';\n\t\t\tconst bearTotemFeatureName = 'Totem Spirit: Bear';\n\n\t\t\t//All remaining values may be changed freely\n\n\t\t\t//Rage chat message flavor text. Actor's name appears immediately before these two strings in the message.\n\t\t\tconst rageMsg = ' is RAAAAAGING!'\n\t\t\tconst endRageMsg =  ' is no longer raging.';\n\n\t\t\t//error and warning messages\n\t\t\tconst errorSelectBarbarian = 'Please select a single barbarian token.';\n\t\t\tconst errorNoRage = ' does not have any rage left, time for a long rest!';\n\t\t\tconst warnMacroNotFound = ' is not a valid macro name, please fix. Rage toggle successful but unable to alter macro.';\n\t\t\tconst errorSelectToken = 'Please select a token.';\n\t\t\tconst errorFailRevert = 'Failed to revert global melee weapon attack bonus, please check manually.';\n//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n\n\n//main\n//check to see if Actor exists and is a barbarian\nif (macroActor !== undefined && macroActor !== null) {\n\n\t// get the barbarian class item\n\tbarb = macroActor.items.find(i => i.name === `${barbClassName}`);\n\tif (barb == undefined) {\n\t\tui.notifications.warn(`${errorSelectBarbarian}`);\n\t}\n\tif (barb !== undefined && barb !== null) {\n\t\tlet enabled = false;\n\t\t// Store the state of the rage toggle flags that indicate if rage is active or not\n\t\tif (macroActor.data.flags.rageMacro !== null && macroActor.data.flags.rageMacro !== undefined) {\n\t\t\tenabled = true;\n\t\t\t\t// Store whether there is also a rage damage bonus currently active\n\t\t\t\tif (macroActor.data.flags.rageMacro[\"rageDmgAdded\"] == true) {\n\t\t\t\t\trageDmgAdded = true;\n\t\t\t\t}\n\t\t}\n\n\t\t//Calculate rage value for use in damage reversion and application\n\t\t// Determining the barbarian level\n\t\tlet barblvl = barb.data.data.levels;\n\n\t\t// Formula to determine the rage bonus damage depending on barbarian level\n\t\tlet lvlCorrection =  barblvl === 16 || barblvl === 17 ? 1 : 0;\n\t\tlet rageDmg = 2 + Math.floor(barblvl / 9) + lvlCorrection;\n\t\tlet dmg = JSON.parse(JSON.stringify(macroActor.data.data.bonuses.mwak.damage));\n\n\t\t// if rage is active, disable it\n\t\tif (enabled) {\n\t\t\tchatMsg = `${macroActor.name} ${endRageMsg}`;\n\t\t\t// reset resistances and melee weapon attack bonus\n\t\t\tlet obj = {};\n\t\t\tobj['flags.rageMacro'] = null;\n\t\t\t//revert damage resistances\n\t\t\tobj['data.traits.dr'] = macroActor.data.flags.rageMacro.oldResistances;\n\n\t\t\t//carefully revert rage global mwak damage bonus to original value, if that bonus is active\n\t\t\t//eventually want to add support so only last instance found is replaced.\n\t\t\tif(rageDmgAdded) {\n\t\t\t\tif (dmg == rageDmg || dmg == null || dmg == undefined || dmg == '' || dmg == 0){\n\t\t\t\t\tconsole.log('Removing simple rage damage');\n\t\t\t\t\tobj['data.bonuses.mwak.damage']='';\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('Removing complex rage damage');\n\t\t\t\t\tlet patt = `\\\\s\\\\+\\\\s${rageDmg}($|[^0123456789dkrxcm(@{])`;\n\t\t\t\t\tlet result = dmg.search(patt);\n\t\t\t\t\tif (result !== -1) {\n\t\t\t\t\t\tlet len = ('' + rageDmg).length;\n\t\t\t\t\t\tlet origDmg = duplicate(dmg);\n\t\t\t\t\t\tlet firstHalfDmg = duplicate(dmg).substring(0,result);\n\t\t\t\t\t\t//Test String: 2d6 + 2 + 2d6\n\t\t\t\t\t\tlet lastHalfDmg = duplicate(dmg).substring(result+3+len, origDmg.length);\n\t\t\t\t\t\tdmg = `${firstHalfDmg}${lastHalfDmg}`;\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage']=dmg;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tui.notifications.error(`${errorFailRevert}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tmacroActor.update(obj);\n\n\t\t// if rage is disabled, enable it\n\t\t} else {\n\t\t\tif (deductResource) {\n\t\t\t\tlet hasAvailableResource = false;\n\t\t\t\tlet newResources = duplicate(macroActor.data.data.resources)\n\t\t\t\tlet obj = {}\n\t\t\t\t// Look for Resources under the Core macroActor data\n\t\t\t\tlet resourceKey = Object.keys(macroActor.data.data.resources).filter(k => macroActor.data.data.resources[k].label === `${rageResourceName}`).shift();\n\t\t\t\tif (resourceKey && (macroActor.data.data.resources[resourceKey].value > 0 || !preventNegativeResource)) {\n\t\t\t\t\thasAvailableResource = true;\n\t\t\t\t\tnewResources[resourceKey].value--;\n\t\t\t\t\tobj['data.resources'] = newResources \n\t\t\t\t\tmacroActor.update(obj);\n\t\t\t\t}\n\t\t\t\tif (!hasAvailableResource) {\n\t\t\t\t\tui.notifications.error(`${macroActor.name} ${errorNoRage}`);\n\t\t\t\t\tnoRage=true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//activate rage if there is rage available, or if it is okay to rage with 0 resources\n\t\t\tif (!noRage) {\n\t\t\t\tchatMsg = `${macroActor.name} ${rageMsg}`;\n\t\t\t\t// update resistance\n\t\t\t\tlet obj = {};\n\t\t\t\t// storing old resistances in flags to restore later\n\t\t\t\tobj['flags.rageMacro.enabled'] = true;\n\t\t\t\tobj['flags.rageMacro.oldResistances'] = JSON.parse(JSON.stringify(macroActor.data.data.traits.dr));\n\t\t\t\t// add bludgeoning, piercing and slashing resistance\n\t\t\t\tlet newResistance = duplicate(macroActor.data.data.traits.dr);\n\t\t\t\tif (newResistance.value.indexOf('bludgeoning') === -1) newResistance.value.push('bludgeoning');\n\t\t\t\tif (newResistance.value.indexOf('piercing') === -1) newResistance.value.push('piercing');\n\t\t\t\tif (newResistance.value.indexOf('slashing') === -1) newResistance.value.push('slashing');\n\t\t\t\t//If bear totem, add bear totem resistances.\n\t\t\t\tbear = macroActor.items.find(i => i.name === `${bearTotemFeatureName}`)\n\t\t\t\tif (bear !== undefined && bear!== null) {\n\t\t\t\t\tif (newResistance.value.indexOf('acid') === -1) newResistance.value.push('acid');\n\t\t\t\t\tif (newResistance.value.indexOf('cold') === -1) newResistance.value.push('cold');\n\t\t\t\t\tif (newResistance.value.indexOf('fire') === -1) newResistance.value.push('fire');\n\t\t\t\t\tif (newResistance.value.indexOf('force') === -1) newResistance.value.push('force');\n\t\t\t\t\tif (newResistance.value.indexOf('lightning') === -1) newResistance.value.push('lightning');\n\t\t\t\t\tif (newResistance.value.indexOf('necrotic') === -1) newResistance.value.push('necrotic');\n\t\t\t\t\tif (newResistance.value.indexOf('poison') === -1) newResistance.value.push('poison');\n\t\t\t\t\tif (newResistance.value.indexOf('radiant') === -1) newResistance.value.push('radiant');\n\t\t\t\t\tif (newResistance.value.indexOf('thunder') === -1) newResistance.value.push('thunder');\n\t\t\t\t}\n\t\t\t\tobj['data.traits.dr'] = newResistance;\n\t\t\t\tmacroActor.update(obj);\n\n\t\t\t\t// For Strength barbarians, update global melee weapon attack bonus to include rage bonus\n\t\t\t\tif (strAttacks) {\n\t\t\t\t\tobj['flags.rageMacro.rageDmgAdded'] = true;\n\t\t\t\t\t// Preserve old mwak damage bonus if there was one, just in case\n\t\t\t\t\tobj['flags.rageMacro.oldDmg'] = JSON.parse(JSON.stringify(dmg));\n\t\t\t\t\t//actually add the bonus rage damage to the previous bonus damage\n\t\t\t\t\t//respect roll formulas by doing string addition if value is already present.\n\t\t\t\t\tif (dmg == null || dmg == undefined || dmg == 0 || dmg == '') {\n\t\t\t\t\t\tconsole.log('Adding simple rage damage');\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage'] = rageDmg;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log('Adding complex rage damage');\n\t\t\t\t\t\tobj['data.bonuses.mwak.damage'] = `${dmg} + ${rageDmg}`;\n\t\t\t\t\t}\n\t\t\t\t\tmacroActor.update(obj);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!noRage) {\n\t\t\t// toggle rage icon, if rage path is defined above\n\t\t\t(async () => { \n\t\t\t\ttoggleResult = await macroToken.toggleEffect(rageIconPath);\n\t\t\t\tif (toggleResult == enabled) macroToken.toggleEffect(rageIconPath);  \n\t\t\t})();\n\t\t\t\n\t\t\t//toggle macro icon and name, if macro name is correct and stop rage icon path is defined\n\t\t\tlet rageMacro = game.macros.getName(rageMacroName);\n\t\t\t\t//check for name of macro in its \"off\" form\n\t\t\t\tif (rageMacro == null || rageMacro == undefined) {\n\t\t\t\t\trageMacro = game.macros.getName('Stop ' + rageMacroName);\n\t\t\t\t}\n\t\t\tlet obj = {};\n\t\t\tif ( (rageMacro !== null && rageMacro !== undefined) && toggleMacro == true && \n\t\t\t\t\t+ (stopRageIconPath !== null && stopRageIconPath !== undefined && stopRageIconPath !== '') ) {\n\t\t\t\tif (enabled) {\n\t\t\t\t  obj['img'] = rageIconPath;\n\t\t\t\t  obj['name'] = rageMacroName;\n\t\t\t\t} else {\n\t\t\t\t  obj['img'] = stopRageIconPath;\n\t\t\t\t  obj['name'] = 'Stop ' + rageMacroName;\n\t\t\t\t}\n\t\t\t\trageMacro.update(obj);\n\t\t\t} else {\n\t\t\tif (toggleMacro == true) ui.notifications.warn(`${rageMacroName} ${warnMacroNotFound}`);\n\t\t\t}\n\t\t}\n\t}\n} else ui.notifications.warn(errorSelectToken);\n// write to chat if needed:\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n\t};\n\tChatMessage.create(chatData, {});\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.whXLG5afXGwYNXEq"},"scene-packer":{"hash":"477f177d13d42a780a9d9831b29783ebf0e34372"}},"_id":"eq67oobytN4Pq1wE"}
{"_id":"erj0Tp0OKGE2t3kX","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"fJ9ilKUVifnhmiJa","name":"24 - T08 - Chromatic Bubble","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/bubble-field.svg","scope":"global","command":"let params =\n[{\n    filterType: \"field\",\n    filterId: \"myChromaField\",\n    shieldType: 8,\n    gridPadding: 2,\n    color: 0xAAAAAA,\n    time: 0,\n    blend: 2,\n    intensity: 1,\n    lightAlpha: 0,\n    lightSize: 0,\n    scale: 1,\n    radius: 1,\n    chromatic: true,\n    zOrder: 512,\n    animated :\n    {\n      time : \n      { \n        active: true, \n        speed: 0.0045, \n        animType: \"move\" \n      }\n    }\n}];\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Compendium.tokenmagic.tmMacros.f74nx1SMT5m8RRn8"},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"g4f4L88B87Goicn3","name":"30 - T01 - Simple Web (web)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/spider-web.svg","scope":"global","command":"let params = \n[{\n    filterType: \"web\",\n    filterId: \"simpleweb\",\n    time: 100,\n    div1: 20,\n    div2: 10,\n    animated :\n    {\n      time : \n      { \n        active: true, \n        speed: 0.0005, \n        animType: \"move\" \n      }\n    }\n}]\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.9gvCwVdvis3NABbI"},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"g6NocUTacGivairM","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 2d20k","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"g9Y5jUIvdfMv2SKR","name":"Ath","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{"combat-utility-belt":{"macroTrigger":""}},"scope":"global","command":"/r 1d20+7","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Speed Factor Initiative","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/*\n* this macro rolls initiative by using the rules for the optional rule \"Speed factor initiative\", available in the Dungeon Master's Guide at page 270\n* select the tokens for which you want to roll initiative and click the macro. \n* Alternatively, if you have an actor assigned and no token selected, the macro will roll initiative for your assigned actor\n* the macro does not roll initiative for actors not in combat\n* requires DnD5e Game System\n* created by Gabro#4634, with the invaluable help of Freeze#2689\n*/\n\n\n//List of actions with their relative bonuses\nvar actions = {\n\t\"Medium Action                  (+0)\" : +0,\n\t\"Melee, Heavy Weapon            (-2)\" : -2,\n\t\"Melee, Light or Finesse Weapon  (+2)\" : +2,\n\t\"Melee, Two-Handed Weapon       (-2)\" : -2,\n\t\"Ranged, Loading Weapon         (-5)\" : -5,\n\t\"Spellcasting, 1st level        (-1)\" : -1,\n\t\"Spellcasting, 2nd level        (-2)\" : -2,\n\t\"Spellcasting, 3rd level        (-3)\" : -3,\n\t\"Spellcasting, 4th level        (-4)\" : -4,\n\t\"Spellcasting, 5th level        (-5)\" : -5,\n\t\"Spellcasting, 6th level        (-6)\" : -6,\n\t\"Spellcasting, 7th level        (-7)\" : -7,\n\t\"Spellcasting, 8th level        (-8)\" : -8,\n\t\"Spellcasting, 9th level        (-9)\" : -9\n//optional rules as suggested by AngryDM (https://theangrygm.com/fine-i-wrote-about-speed-factor-initiative-in-dd-5e/), remove them if you don't want them\n   ,\"Very Slow Action               (-5)\" : -5,\n\t\"Slow Action                    (-2)\" : -2,\n\t\"Fast Action                    (+2)\" : +2,\n\t\"Very Fast Action               (+5)\" : +5\n}\n\n// this option, as it is, disables the possibility to modify the box relative to the size and dex initiative bonus. If you want to modify them, change it to:\n// var disableTexts = ''\nvar disableTexts = 'disabled=\"disabled\"'\n\n\n// list of sizes present in 5e, optionally it's possible to modify the bonuses (but not the size names \"tiny\", \"sm\", etc)\nvar sizes = {\n  \"tiny\" : +5,\n  \"sm\" : +2,\n  \"med\" : +0,\n  \"lg\" : -2,\n  \"huge\" : -5,\n  \"grg\" : -8\n};\n\nvar options = new Array ()\nfor (var key in actions) {\noptions.push(key)\n}\n\nif (canvas.tokens.controlled.length >= 1) {\n\t(async ()=>{\n\t\tfor (let token of canvas.tokens.controlled) {\n\t\t\tlet combatant = game.combats.active.combatants.find(c => c.tokenId === token.id)\n\t\t\tif (combatant == null){\n\t\t\t\tconsole.log(token.name + \" is not in combat\")\n\t\t\t} else {\n\t\t\t\tlet data = [\n\t\t\t\t{type : `text`, label : `Base modifier : `, options : `${token.actor.data.data.attributes.init.total}` },\n\t\t\t\t{type : `text`, label : `Size modifier : `, options : `${sizes[token.actor.data.data.traits.size]}` },\n\t\t\t\t{type : `select`, label : `Action : `, options}\n\t\t\t];\n                let rv = await quick_dialog({data}, combatant.name);\n\t\t\t\trollInit(token, rv)\n\t\t\t}\n\t\t}\n\t})();\n} else {\n\t(async ()=>{\n\t\tif (game.user.character == null){\n\t\t\tconsole.log(\"player has no player selected in player configuration menu\")\n\t\t} else {\n\t\t\tfor (let token of game.user.character.getActiveTokens()) {\n\t\t\t\tlet combatant = game.combats.active.combatants.find(c => c.tokenId === token.id)\n\t\t\t\tif (combatant == null){\n\t\t\t\t\tconsole.log(token.name + \" is not in combat\")\n\t\t\t\t} else {\n\t\t\t\t\tlet data = [\n\t\t\t\t\t{type : `text`, label : `Base modifier : `, options : `${token.actor.data.data.attributes.init.total}` },\n\t\t\t\t\t{type : `text`, label : `Size modifier : `, options : `${sizes[token.actor.data.data.traits.size]}` },\n\t\t\t\t\t{type : `select`, label : `Action : `, options}\n\t\t\t\t\t];\n\t\t\t\t\tlet rv = await quick_dialog({data}, combatant.name);\n\t\t\t\t\trollInit(token, rv)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t})();\n}\n\n\n\nasync function quick_dialog({data, title = `Select your action for `} = {}, name)\n{\n  data = data instanceof Array ? data : [data];\n\n  let value = await new Promise((resolve) => {\n    let content = `\n    <table style=\"width:100%\">\n      ${data.map(({type, label, options}, i)=> {\n        if(type.toLowerCase() === `select`)\n        {\n          return `<tr><th style=\"width:50%\"><label>${label}</label></th><td style=\"width:50%\"><select id=\"${i}qd\">${options.map((e,i)=> `<option value=\"${e}\">${e}</option>`).join(``)}</td></tr>`;\n        }else{\n          return `<tr><th style=\"width:50%\"><label>${label}</label></th><td style=\"width:50%\"><input type=\"${type}\" ${disableTexts} id=\"${i}qd\" value=\"${options instanceof Array ? options[0] : options}\"/></td></tr>`;\n        }\n      }).join(``)}\n    </table>`;\n\n    new Dialog({\n      title : title + name,\n\t  content,\n      buttons : {\n        Ok : { label : `Roll Initiative!`, callback : (html) => {\n          resolve(Array(data.length).fill().map((e,i)=>{\n            let {type} = data[i];\n            if(type.toLowerCase() === `select`)\n            {\n              return html.find(`select#${i}qd`).val();\n            }else{\n                return html.find(`input#${i}qd`)[0].value;\n            }\n          }));\n        }}\n      }\n    }).render(true);\n  });\n  return value;\n}\n\nfunction rollInit(selectedToken, initBonus){\n\tlet combatant = game.combats.active.combatants.find(c => c.tokenId === selectedToken.id)\n\tvar formula = ''\n\tif (selectedToken.actor.data.flags != null && selectedToken.actor.data.flags.dnd5e != null && selectedToken.actor.data.flags.dnd5e.initiativeAdv){\n\t\tformula = '2d20kh + @dexBonus + @sizemod + @init'\n\t} else {\n\t\tformula = '1d20 + @dexBonus + @sizemod + @init'\n\t}\n\tlet r= new Roll(formula, {dexBonus : initBonus[0], sizemod: initBonus[1], init: actions[initBonus[2]]}).roll()\n\nr.toMessage({flavor : `${combatant.name} chooses ${initBonus[2]} and rolls for Initiative!`});\ngame.combats.active.updateCombatant({_id: combatant._id, initiative: r.total})\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.R3WnKSOQFZnuZrTf"},"scene-packer":{"hash":"8d2296d30b43e516db937047f0eb01a388588c7a"}},"_id":"hQ1Hro0gb4ecxS9l"}
{"name":"Symbiotic Entity","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Symbiotic Entity\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"hcXqRvEdw6J6yR2m"}
{"_id":"iCSfa5Koaq70Aynz","name":"Open Quest Log","type":"script","author":"NGNjNjcwYTg1OTY5","img":"modules/forien-quest-log/assets/icons/macros/openQuestLog.png","scope":"global","command":"Hooks.call('ForienQuestLog.Open.QuestLog');","folder":"mGB5wXs6msf7dm6H","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.forien-quest-log.macros-player.DycgxgyiO738kHNb"},"scene-packer":{"hash":"30dc6ba1db4619f673dbfb04d1a8561574b95103"},"combat-utility-belt":{"macroTrigger":""}}}
{"name":"Protection from Evil and Good","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/protect-sky-2.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Protection from Evil and Good\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"juPgvbsvH6OtsSAD"}
{"name":"Entangle","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Entangle\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/vines-acid-2.jpg","actorIds":[],"_id":"juouWfNqanOB36jc"}
{"name":"Flaming Sphere","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/light-air-fire-3.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Flaming Sphere\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"kEuDTNAR5gtoCcOZ"}
{"name":"Guidance","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Guidance\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/haste-sky-1.jpg","actorIds":[],"_id":"kOScdkKdVe0dFhnF"}
{"name":"Thunder Step","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Thunder Step\");","author":"NGIwMDczNDc3YmVi","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"kRdpyEcbdTgJ1iiy"}
{"name":"Healing Word","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Healing Word\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/heal-jade-1.jpg","actorIds":[],"_id":"ksbBXE6woM0I8cem"}
{"name":"Dispel Magic","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Dispel Magic\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/slice-orange-2.jpg","actorIds":[],"_id":"lWvxiWPvoeUfSEEA"}
{"name":"Bane","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// new build for Bane macro by Penguin#0949 with help from Kotetsushin#7680\n// version beta 4.2.0\n\n// user notes\n// this macro is inteded for use by the recipient of the Bane spell in D&D 5e on Forge VTT\n// N.B. every recipient will need to use this macro independantly on their own Actor/token.\n\n//user modifiable declarations CHANGE AT YOUR OWN RISK\nconst baneIconPath = 'icons/svg/degen.svg';\nlet baneMsg = ' is Baned!';\nlet endbaneMsg = ' is no longer Baned.';\n\n//fixed declarations DO NOT MODIFY\nlet macroActor = token.actor;\nlet chatMsg = '';\nlet Baned = macroActor.effects.find(i => i.data.label === \"Baned\")\nlet bane = {\n    changes: [\n        {\n            key: \"data.bonuses.mwak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"-1d4\",\n        },\n        {\n            key: \"data.bonuses.rwak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"-1d4\",\n        },\n\t\t{\n            key: \"data.bonuses.msak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"-1d4\",\n        },\n\t\t{\n            key: \"mdata.bonuses.rsak.attack\",\n            mode: 2,\n            priority: 20,\n            value: \"-1d4\",\n        },\n\t\t{\n            key: \"data.bonuses.abilities.save\",\n            mode: 2,\n            priority: 20,\n            value: \"-1d4\",\n        },\n    ],\n    duration: {\n        seconds: 60,\n    },\n    icon: baneIconPath,\n    label: \"Baned\"\n}\n//identify token\nif (macroActor === undefined || macroActor === null) {\n  ui.notifications.warn(\"Please select a token first.\");\n} \nelse {\n// If already bless\t\nif (Baned) {\n    macroActor.deleteEmbeddedDocuments(\"ActiveEffect\", [Baned.id])\n// anounce to chat\n\tchatMsg = `${macroActor.name} ${endbaneMsg}`;\n}\n// if not already bless\t\nelse {\n    macroActor.createEmbeddedDocuments(\"ActiveEffect\", [bane])\t\n// anounce to chat\n\t\tchatMsg = `${macroActor.name} ${baneMsg}`;\n}\n// write to chat if needed:\nif (chatMsg !== '') {\n\tlet chatData = {\n\t\tuser: game.user._id,\n\t\tspeaker: ChatMessage.getSpeaker(),\n\t\tcontent: chatMsg\n\t};\n\tChatMessage.create(chatData, {});\n}\n}","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.VI7m4TbGvbs99h3O"},"scene-packer":{"hash":"c2c27f17659eb1999b1d23b60c6fd35e868c396c"}},"_id":"mI9L2jvh6zFsZT6i"}
{"name":"Random Cutting Words","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Courtesy of @Zarek\n// Selected target receives a random cutting word from a table called \"Mockeries\" along with the roll reduction.\n// You can find a mockeries table in the community table module.\n\nlet cuttingWords = async () => {\n  // Setup variables\n  let tableName = \"mockeries\";\n  let mockery = \"Now go away or I shall taunt you a second time-a!\"; // if table can't be found, use this.\n\n  if (!actor) {\n    ui.notifications.warn(\"You must have an actor selected.\");\n    return\n  }\n\n  let actorLevels = actor.data.data.levels || 1;\n  let table = game.tables.contents.find(t => t.name == tableName);\n  // Get Targets name\n  const targetId = game.user.targets.ids[0];\n  const targetToken = canvas.tokens.get(targetId);\n  if (!targetToken) {\n    ui.notifications.warn(\"You must target a token.\");\n    return\n  }\n  const targetName = targetToken.name;\n\n  // Roll the result, and mark it drawn\n  if (table) {\n    if (checkTable(table)) {\n      let roll = await table.roll();\n      let result = roll.results[0];\n      mockery = result.data.text;\n      await table.updateEmbeddedDocuments(\"TableResult\", [{\n        _id: result.id,\n        drawn: true\n      }]);\n    }\n  }\n\n  function checkTable(table) {\n    let results = 0;\n    for (let data of table.data.results) {\n      if (!data.drawn) {\n        results++;\n      }\n    }\n    if (results < 1) {\n      table.reset();\n      ui.notifications.notify(\"Table Reset\")\n      return false\n    }\n    return true\n  }\n\n  let dieType = 'd6';\n  if (actorLevels >= 15) {\n    dieType = 'd12';\n  } else if (actorLevels >= 10) {\n    dieType = 'd10';\n  } else if (actorLevels >= 5) {\n    dieType = 'd8';\n  }\n\n  let messageContent = `<p>${targetName} Reduce your roll by: <b>[[1${dieType}]]</b>.</p>`\n  messageContent += `<p>${token.name} exclaims <b><i>\"${mockery}\"</i></b></p>`\n  messageContent += `<details closed=\"\"><summary><a>Cutting Words</a></summary>\n  <p>When a creature that you can see within 60 feet of you makes an <b>Attack roll, an ability check, or a damage roll</b>, you can use your <b>Reaction</b> to expend one of your uses of <b>Bardic Inspiration</b>,\n  rolling a Bardic Inspiration die and subtracting the number rolled from the creatureâ€™s roll.</p>\n  <p>You can choose to use this feature after the creature makes its roll, but before the GM determines whether the Attack roll or ability check succeeds or fails, or before the creature deals its damage. \n  The creature is immune if it canâ€™t hear you or if itâ€™s immune to being <b>Charmed</b>.</p></details>`\n\n  // create the message\n  if (messageContent !== '') {\n    let chatData = {\n      user: game.user.id,\n      speaker: ChatMessage.getSpeaker(),\n      content: messageContent,\n    };\n    ChatMessage.create(chatData, {});\n  }\n};\n\ncuttingWords();","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.AbzZdXi97q8oHOUn"},"scene-packer":{"hash":"d9cf7d7e3a4890e8e8c2a2b9e46b5783366674b1"}},"_id":"my5JzhrFruxWA321"}
{"name":"Random Cutting Words","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Courtesy of @Zarek\n// Selected target receives a random cutting word from a table called \"Mockeries\" along with the roll reduction.\n// You can find a mockeries table in the community table module.\n\nlet cuttingWords = async () => {\n  // Setup variables\n  let tableName = \"mockeries\";\n  let mockery = \"Now go away or I shall taunt you a second time-a!\"; // if table can't be found, use this.\n\n  if (!actor) {\n    ui.notifications.warn(\"You must have an actor selected.\");\n    return\n  }\n\n  let actorLevels = actor.data.data.levels || 1;\n  let table = game.tables.contents.find(t => t.name == tableName);\n  // Get Targets name\n  const targetId = game.user.targets.ids[0];\n  const targetToken = canvas.tokens.get(targetId);\n  if (!targetToken) {\n    ui.notifications.warn(\"You must target a token.\");\n    return\n  }\n  const targetName = targetToken.name;\n\n  // Roll the result, and mark it drawn\n  if (table) {\n    if (checkTable(table)) {\n      let roll = await table.roll();\n      let result = roll.results[0];\n      mockery = result.data.text;\n      await table.updateEmbeddedDocuments(\"TableResult\", [{\n        _id: result.id,\n        drawn: true\n      }]);\n    }\n  }\n\n  function checkTable(table) {\n    let results = 0;\n    for (let data of table.data.results) {\n      if (!data.drawn) {\n        results++;\n      }\n    }\n    if (results < 1) {\n      table.reset();\n      ui.notifications.notify(\"Table Reset\")\n      return false\n    }\n    return true\n  }\n\n  let dieType = 'd6';\n  if (actorLevels >= 15) {\n    dieType = 'd12';\n  } else if (actorLevels >= 10) {\n    dieType = 'd10';\n  } else if (actorLevels >= 5) {\n    dieType = 'd8';\n  }\n\n  let messageContent = `<p>${targetName} Reduce your roll by: <b>[[1${dieType}]]</b>.</p>`\n  messageContent += `<p>${token.name} exclaims <b><i>\"${mockery}\"</i></b></p>`\n  messageContent += `<details closed=\"\"><summary><a>Cutting Words</a></summary>\n  <p>When a creature that you can see within 60 feet of you makes an <b>Attack roll, an ability check, or a damage roll</b>, you can use your <b>Reaction</b> to expend one of your uses of <b>Bardic Inspiration</b>,\n  rolling a Bardic Inspiration die and subtracting the number rolled from the creatureâ€™s roll.</p>\n  <p>You can choose to use this feature after the creature makes its roll, but before the GM determines whether the Attack roll or ability check succeeds or fails, or before the creature deals its damage. \n  The creature is immune if it canâ€™t hear you or if itâ€™s immune to being <b>Charmed</b>.</p></details>`\n\n  // create the message\n  if (messageContent !== '') {\n    let chatData = {\n      user: game.user.id,\n      speaker: ChatMessage.getSpeaker(),\n      content: messageContent,\n    };\n    ChatMessage.create(chatData, {});\n  }\n};\n\ncuttingWords();","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.AbzZdXi97q8oHOUn"},"scene-packer":{"hash":"d9cf7d7e3a4890e8e8c2a2b9e46b5783366674b1"}},"_id":"n6Z10g3efrAbDuoq"}
{"_id":"oQ9s74Z2oYoKNFsC","name":"2d20","permission":{"default":0,"ZGFkODQ5MzM2NTJk":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 2d20","author":"ZGFkODQ5MzM2NTJk","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Show asset report","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/hazard.svg","scope":"global","command":"// This macro shows an asset report that details the assets\n// in this world and whether they have \"external\" dependencies.\n//\n// Use it to help determine whether your packaged module will\n// result in broken assets (images, sounds etc.).\n\nnew ScenePacker.AssetReport();","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.CIKJ4iAmyMvhtptI"},"scene-packer":{"hash":"978019212c78ef71710efefbd65eabeb4b801d8d"}},"_id":"oSwvXs1suA1MTG8A"}
{"name":"Cure Wounds","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Cure Wounds\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/heal-jade-1.jpg","actorIds":[],"_id":"p3qjJSAk2qUSkBrX"}
{"name":"Wall of Thorns","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Wall of Thorns\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/beam-acid-3.jpg","actorIds":[],"_id":"p4HKnuZTaKoUr1kM"}
{"name":"Divine Smite","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/*\n * The Smite macro emulates the Divine Smite feature of Paladins in DnD 5e. A spell slot level to use\n * can be selected, which increases the number of damage dice, and smiting a fiend or undead\n * will also increase the number of damage dice.\n * \n * If a token is not selected, the macro will default back to the default character for the Actor. \n * This allows for the GM to cast the macro on behalf a character that possesses it, \n * without requiring that a PC have their character selected.\n * To execute the macro a target MUST be specified and, unless configured otherwise, the character must have an available spell slot. \n * Make your regular attack and then if you choose to use Divine Smite, run this macro.\n */\n\n(() => {\n\n//Configurable variables\nlet maxSpellSlot = 5; //  Highest spell-slot level that may be used.\nlet affectedCreatureTypes = [\"fiend\", \"undead\", \"undead (shapechanger)\"]; //  Creature types that take extra damage.\n\n// Use token selected, or default character for the Actor if none is.\nlet s_actor = canvas.tokens.controlled[0]?.actor || game.user.character;     \n\n// Flag for selected slot type\nlet pactSlot = false;\n\n// Verifies if the actor can smite.\nif (s_actor?.data.items.find(i => i.name === \"Divine Smite\") === undefined){\n    return ui.notifications.error(`No valid actor selected that can use this macro.`);\n}\n\nlet confirmed = false;\nif (hasAvailableSlot(s_actor)) {\n\n    // Get options for available slots\n    let optionsText = \"\";\n    let i = 1;\n    for (; i < maxSpellSlot; i++) {\n        const slots = getSpellSlots(s_actor, i, false);\n        if (slots.value > 0) {\n            const level = CONFIG.DND5E.spellLevels[i];\n            const label = game.i18n.format('DND5E.SpellLevelSlot', {level: level, n: slots.value});\n            optionsText += `<option value=\"${i}\">${label}</option>`;\n        }\n    }\n\n    // Check for Pact slot\n    const slots = getSpellSlots(s_actor, 0, true);\n    if(slots.value > 0) {\n        i++;\n        const level = CONFIG.DND5E.spellLevels[slots.level];\n        const label = 'Pact: ' + game.i18n.format('DND5E.SpellLevelSlot', {level: level, n: slots.value});\n        optionsText += `<option value=\"${i}\">${label}</option>`;\n    }\n\n    // Create a dialogue box to select spell slot level to use when smiting.\n    new Dialog({\n        title: \"Divine Smite: Usage Configuration\",\n        content: `\n        <form id=\"smite-use-form\">\n            <p>` + game.i18n.format(\"DND5E.AbilityUseHint\", {name: \"Divine Smite\", type: \"feature\"}) + `</p>\n            <div class=\"form-group\">\n                <label>Spell Slot Level</label>\n                <div class=\"form-fields\">\n                    <select name=\"slot-level\">` + optionsText + `</select>\n                </div>\n            </div>\n\n            <div class=\"form-group\">\n                <label class=\"checkbox\">\n                <input type=\"checkbox\" name=\"consumeCheckbox\" checked/>` + game.i18n.localize(\"DND5E.SpellCastConsume\") + `</label>\n            </div>\n\n            <div class=\"form-group\">\n                <label class=\"checkbox\">\n                <input type=\"checkbox\" name=\"criticalCheckbox\"/>` + game.i18n.localize(\"DND5E.CriticalHit\") + \"?\" + `</label>\n            </div>\n        </form>\n        `,\n        buttons: {\n            one: {\n                icon: '<i class=\"fas fa-check\"></i>',\n                label: \"SMITE!\",\n                callback: () => confirmed = true\n            },\n            two: {\n                icon: '<i class=\"fas fa-times\"></i>',\n                label: \"Cancel\",\n                callback: () => confirmed = false\n            }\n        },\n        default: \"Cancel\",\n        close: html => {\n            if (confirmed) {\n                let slotLevel = parseInt(html.find('[name=slot-level]')[0].value);\n                if(slotLevel > maxSpellSlot) {\n                    slotLevel = actor.data.data.spells.pact.level;\n                    pactSlot = true;\n                }\n                const criticalHit = html.find('[name=criticalCheckbox]')[0].checked;\t\t\t\t\n                const consumeSlot = html.find('[name=consumeCheckbox]')[0].checked;\n                smite(s_actor, slotLevel, criticalHit, consumeSlot, pactSlot);\n            }\n        }\n    }).render(true);\n\n} else {\n    return ui.notifications.error(`No spell slots available to use this feature.`);    \n}\n\n/**\n * Gives the spell slot information for a particular actor and spell slot level.\n * @param {Actor5e} actor - the actor to get slot information from.\n * @param {integer} level - the spell slot level to get information about. level 0 is deprecated.\n * @param {boolean} isPact - whether the spell slot is obtained through pact.\n * @returns {object} contains value (number of slots remaining), max, and override.\n */\nfunction getSpellSlots(actor, level, isPact) {\n    if(isPact == false) {\n        return actor.data.data.spells[`spell${level}`];\n    }\n    else {\n        return actor.data.data.spells.pact;\n    }\n}\n\n/**\n * Returns whether the actor has any spell slot left.\n * @param {Actor5e} actor - the actor to get slot information from.\n * @returns {boolean} True if any spell slots of any spell level are available to be used.\n */\n function hasAvailableSlot(actor) {\n    for (let slot in actor.data.data.spells) {\n        if (actor.data.data.spells[slot].value > 0) {\n            return true;\n        }\n    }\n    return false;\n }\n\n/**\n * Use the controlled token to smite the targeted token.\n * @param {Actor5e} actor - the actor that is performing the action.\n * @param {integer} slotLevel - the spell slot level to use when smiting.\n * @param {boolean} criticalHit - whether the hit is a critical hit.\n * @param {boolean} consume - whether to consume the spell slot.\n * @param {boolean} isPact - whether the spell slot used is obtained through pact.\n */\nfunction smite(actor, slotLevel, criticalHit, consume, isPact) {\n    let targets = game.user.targets;\n\n    let chosenSpellSlots = getSpellSlots(actor, slotLevel, isPact);\n\n    if (chosenSpellSlots.value < 1) {\n        ui.notifications.error(\"No spell slots of the required level available.\");\n        return;\n    }\n    if (targets.size !== 1) {\n        ui.notifications.error(\"You must target exactly one token to Smite.\");\n        return;\n    }\n\n    targets.forEach(target => {\n        let numDice = slotLevel + 1;\n        let type = target.actor.data.data.details.type.value?.toLocaleLowerCase();\n        if (affectedCreatureTypes.includes(type)) numDice += 1;\n        if (criticalHit) numDice *= 2;\n        const flavor = `Macro Divine Smite - ${game.i18n.localize(\"DND5E.DamageRoll\")} (${game.i18n.localize(\"DND5E.DamageRadiant\")})`;\n        let damageRoll = new Roll(`${numDice}d8`);\n\n        let targetActor = game.user.targets.values().next().value.actor;\n        \n        if (targetActor.permission !== CONST.ENTITY_PERMISSIONS.OWNER) {\n            // We need help applying the damage, so make a roll message for right-click convenience.\n            damageRoll.roll().toMessage({\n                speaker: ChatMessage.getSpeaker(),\n                flavor: `${actor.name} smited ${targetActor.data.name}.<br>${flavor}\n                <p><em>Manually apply (or right-click) ${damageRoll.result} HP of damage to ${targetActor.data.name}</em></p>` });\n        }\n        else {\n            // We can apply damage automatically, so just show a normal chat message.\n            damageRoll.roll().toMessage({\n                speaker: ChatMessage.getSpeaker(),\n                flavor: `${actor.name} smited ${targetActor.data.name}.<br>${flavor}\n                <p><em>${targetActor.data.name} has taken ${damageRoll.result} HP of damage.</em></p>` });\n            targetActor.update({\"data.attributes.hp.value\" : targetActor.data.data.attributes.hp.value - damageRoll.result});\n        }\n    })\n\n    if (consume){\n        let objUpdate = new Object();\n        if(isPact == false) {\n            objUpdate['data.spells.spell' + slotLevel + '.value'] = chosenSpellSlots.value - 1;\n        }\n        else {\n            objUpdate['data.spells.pact.value'] = chosenSpellSlots.value - 1;\n        }\n        \n        actor.update(objUpdate);\n    }\n}\n\n})();","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.mzvF9reAuonv5d4a"},"scene-packer":{"hash":"df3072a6b35a154a517c2dd332785dd8aed49f49"}},"_id":"pxAmYYyECoe1S1Wk"}
{"_id":"qSemk5g4UlltsBEp","name":"Enable Quest Tracker","type":"script","author":"NGNjNjcwYTg1OTY5","img":"modules/forien-quest-log/assets/icons/macros/questTrackerEnableOn.png","scope":"global","command":"const newState = !game.settings.get('forien-quest-log', 'questTrackerEnable');\nawait game.settings.set('forien-quest-log', 'questTrackerEnable', newState);","folder":"mGB5wXs6msf7dm6H","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"forien-quest-log":{"macro-setting":"questTrackerEnable"},"core":{"sourceId":"Compendium.forien-quest-log.macros-player.03i1Qj8atS4zqJh0"},"scene-packer":{"hash":"02ab46952fbeacff5034a672ca6b89bcbd22baf9"},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"qo2uqKejskHMOizw","name":"2d20","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 2d20","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Two-handed Unarmed Strike","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Two-handed Unarmed Strike\");","author":"NThiNDE0MDE3NTcx","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"quhikRkquTV2oXkM"}
{"_id":"rzvFDanYxpTetyc3","name":"Sovereign Glue (1 use)","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"icons/consumables/drinks/tea-jug-gourd-brown.webp","scope":"global","command":"game.dnd5e.rollItemMacro(\"Sovereign Glue (1 use)\");","folder":null,"sort":100001,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}}}
{"name":"Show Tokens Resistances","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"// Prints the condition immunities, damage immunities, damage resistances and damage vulnerabilities of the currently selected token(s).\n// Damage types that appeared in the previous chat message (e.g. due to a roll) are highlighted in red. \n// A DM can call this macro after a player rolled damage to quickly see if they need to apply full, half or double damage.\n//\n// Author: https://github.com/Nijin22\n// Licence: MIT, see https://choosealicense.com/licenses/mit/\n\nconst damageTypes = [\"Acid\", \"Bludgeoning\", \"Cold\", \"Fire\", \"Force\", \"Lightning\", \"Necrotic\", \"Piercing\", \"Non-Magical Physical\",\n                     \"Piercing\", \"Poison\", \"Psychic\", \"Radiant\", \"Slashing\", \"Thunder\",\n                     \"Bludgeoning, Piercing, and Slashing from Nonmagical Attacks\"];\n\nlet msg = \"\";\nlet previousMessage;\ntry { \n    previousMessage = game.messages.entries[game.messages.entries.length-1].data.content;\n} catch (e) {\n    // No previous message in log. Default to an empty string.\n    previousMessage = \"\";\n}\n\n// Enable case-insensitive replacements\n// Source: https://stackoverflow.com/a/7313467\nString.prototype.replaceAllCaseInsensitive = function(strReplace, strWith) {\n    // See http://stackoverflow.com/a/3561711/556609\n    var esc = strReplace.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&');\n    var reg = new RegExp(esc, 'ig');\n    return this.replace(reg, strWith);\n};\n\n\n// Get traits\nconst traits = new Map();\ntraits.set(\"ci\", \"Condition Immunities\");\ntraits.set(\"di\", \"Damage Immunities (No damage)\");\ntraits.set(\"dr\", \"Damage Resistances (Half damage)\");\ntraits.set(\"dv\", \"Damage Vulnerabilities (Double dmg)\");\ncanvas.tokens.controlled.forEach(token => {\n    let name = token.actor.name;\n    msg += `<h2>${name}</h2>`;\n    \n    traits.forEach((traitDescr, traitId, map) => {\n        // Clone 'default' 5e trait array\n        var allTraits = [...token.actor.data.data.traits[traitId].value];\n        \n        // Custom traits\n        allTraits = allTraits.concat(token.actor.data.data.traits[traitId].custom.split(\";\").map(x => x.trim()));\n        \n        var printableTraits = allTraits.join(\"; \");\n        if (printableTraits.length == 0) {\n            printableTraits = \"-\";\n        }\n        msg += `<h3>${traitDescr}</h3><p>${printableTraits}</p>`;\n    });\n});\n\n// highlight words from previous message\nlet damageTypesOfPrevousMsg = [];\ndamageTypes.forEach(damageType => {\n    if (previousMessage.toLowerCase().indexOf(damageType.toLowerCase()) != -1){\n        damageTypesOfPrevousMsg.push(damageType);\n    }\n});\ndamageTypesOfPrevousMsg.forEach(damageType => {\n    msg = msg.replaceAllCaseInsensitive(damageType, `<span style=\"color:red; font-weight: bold;\">${damageType}</span>`);\n});\n\n\nif (msg.length === 0) {\n    msg = \"No tokens selected.\";\n}\n\nui.notifications.info(msg);\n\n// Post message to self\n/*ChatMessage.create({\n    content: msg,\n    whisper: [game.user._id]\n});*/","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.4WhSSiHXlbcvP7f6"},"scene-packer":{"hash":"a630bd4cc2f92a5edb50bc1f13ce80042ca91c7e"}},"_id":"s3ePkcpDypcvFYck"}
{"name":"Summon Beast","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Summon Beast\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"sSL4t0hcQ8NYrVvv"}
{"_id":"sjaWQwb4z0cxOtJo","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 2d20kl","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"New Macro","type":"chat","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"","folder":null,"sort":0,"permission":{"default":0,"NGNjNjcwYTg1OTY5":3},"flags":{},"_id":"tfsFEv7WSX4hzlLH"}
{"name":"Thorn Whip","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Thorn Whip\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"tjZjUCKMl5y3aK6C"}
{"_id":"tm2O3yLwVUEXa8SP","name":"31 - T02 - Fairy Outline (globes+glow)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"https://gloomygus.s3.us-east-2.amazonaws.com/moulinette/images/gameicons/spotted-mushroom.svg","scope":"global","command":"// works better with non-round forms\nlet params = \n[{\n    filterType: \"globes\",\n    filterId: \"glowingGlobes\",\n    time: 0,\n    color: 0x3080EE,\n    distortion: 0.9,\n    scale: 320,\n    alphaDiscard: true,\n    zOrder: 1,\n    animated :\n    {\n      time : \n      { \n        active: true, \n        speed: 0.0015, \n        animType: \"move\" \n      }\n    }\n},\n{\n    filterType: \"glow\",\n    filterId: \"superSpookyGlow\",\n    outerStrength: 4,\n    innerStrength: 0,\n    color: 0xFF3000,\n    quality: 0.5,\n    padding: 10,\n    animated:\n    {\n        color: \n        {\n           active: true, \n           loopDuration: 3000, \n           animType: \"colorOscillation\", \n           val1:0xFF3000, \n           val2:0x30FF00\n        }\n    }\n}]\n\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.URg5jbccjFontPwQ"},"scene-packer":{"hash":"da73335a33ff5634cd92ce3ce99ba605e93441fa"},"combat-utility-belt":{"macroTrigger":""}}}
{"name":"Monk Ki","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"/**\n * Monk Ki Point spender\n * \n * This macro will prompt which Feature you want to spend Ki points on.\n * \n * Flurry of Blows: Automatically cast two Unarmed Strike's\n * Stunning Strike: Automatically show the saving throw DC\n * Deflect Missiles: Automatically show the damage reduction\n */\n(async () => {\n    const kiName = \"Ki Points\";\n    const errNoMonkToken = \"Please select a single monk token.\";\n\n    const sendChat = async (msg) => {\n        let chatData = {\n            user: game.user.id,\n            speaker: ChatMessage.getSpeaker(),\n            content: msg,\n        };\n        ChatMessage.create(chatData, {});\n    }\n\n    if (!actor) {\n        ui.notifications.warn(errNoMonkToken);\n        return\n    }\n\n    let monk = actor.items.find(i => i.name === 'Monk' && i.type === 'class');\n    if (!monk) {\n        ui.notifications.warn(errNoMonkToken);\n        return\n    }\n\n    let monkLevels = monk.data.data.levels || 20;\n    //let subClass = monk.data.data.subclass;\n\n    if (monkLevels < 2) {\n        ui.notifications.warn('You must have a least 2 Monk levels to use ki points.');\n        return\n    }\n\n    class KiFeature {\n        /**\n         * @param {string} name\n         * @param {string} fallbackText\n         * @param {number} requireLevel\n         * @param {function} action\n         * @param {function} appendTemplate\n         * @param {number} kiCost\n         */\n        constructor(name, fallbackText, requireLevel, action, appendTemplate, kiCost) {\n            this.name = name;\n            this.fallbackText = fallbackText;\n            this.requireLevel = requireLevel;\n            this.kiCost = kiCost || 1;\n            if (action) {\n                this.action = action;\n            }\n            if (appendTemplate) {\n                this.appendTemplate = appendTemplate;\n            }\n        }\n\n        render(allowHigher) {\n            let entry = null;\n\n            const pack = game.packs.get(\"dnd5e.classfeatures\");\n            if (!pack) {\n                console.warn('Could not find \"dnd5e.classfeatures\" compendium.');\n            } else {\n                entry = pack.index.find(e => e.name === this.name);\n            }\n\n            if (!allowHigher && this.requireLevel && monkLevels && this.requireLevel > monkLevels) {\n                ui.notifications.warn(`You need to have ${this.requireLevel} monk levels, you only have ${monkLevels}.`)\n                return\n            }\n\n            if (entry) {\n                pack.getDocument(entry._id).then(o => {\n                    let template = `@Compendium[dnd5e.classfeatures.${entry._id}]{${this.name}}\n                    ${o.data.data.description.value}`;\n                    if (this.appendTemplate) {\n                        template += '\\n\\n' + this.appendTemplate();\n                    }\n                    sendChat(template);\n                    if (this.action) {\n                        this.action();\n                    }\n                });\n            } else {\n                console.warn(`Could not find \"${this.name}\" entry in compendium.`);\n                let template = this.fallbackText;\n                if (this.appendTemplate) {\n                    template += '\\n\\n' + this.appendTemplate();\n                }\n                sendChat(template);\n                if (this.action) {\n                    this.action();\n                }\n            }\n        }\n    }\n\n    const openHand = !!actor.items.find(o => o.data.name === 'Open Hand Technique') ? `<br />In addition, you can impose one of the following: <ul><li>It must succeed on a <b>Dexterity</b> saving throw or be knocked prone.</li><li>It must make a <b>Strength</b> saving throw. If it fails, you can push it up to 15 feet away from you.</li><li>It canâ€™t take reactions until the end of your next turn.</li></ul> Saving throw <b>DC ${10 + actor.data.data.abilities.wis.mod}</b>` : \"\";\n\n    const features = [\n        new KiFeature(\"Ki: Flurry of Blows\",\n            `Immediately after you take the <b>Attack</b> action on your turn, you can spend 1 ki point to make two unarmed strikes as a bonus action. ${openHand}`,\n            2,\n            function () {\n                // Automatically roll two Unarmed Strike attacks\n                let strike = actor.items.find(o => o.data.name === 'Unarmed Strike' && o.labels.activation === '1 Action')\n                if (strike) {\n                    strike.roll();\n                    strike.roll();\n                }\n            }),\n        new KiFeature(\"Ki: Patient Defense\",\n            \"You can spend 1 ki point to take the <b>Dodge</b> action as a bonus action on your turn.\",\n            2),\n        new KiFeature(\"Ki: Step of the Wind\",\n            \"You can spend 1 ki point to take the <b>Disengage</b> or <b>Dash</b> action as a bonus action on your turn, and your jump distance is doubled for the turn.\",\n            2),\n        new KiFeature(\"Deflect Missiles\",\n            `Starting at 3rd level, you can use your reaction to deflect or catch the missile when you are hit by a ranged weapon attack. When you do so, the damage you take from the attack is reduced by 1d10 + your Dexterity modifier + your monk level. <br />\n\n        If you reduce the damage to 0, you can catch the missile if it is small enough for you to hold in one hand and you have at least one hand free. If you catch a missile in this way, you can spend 1 ki point to make a ranged attack with the weapon or piece of ammunition you just caught, as part of the same reaction. You make this attack with proficiency, regardless of your weapon proficiencies, and the missile counts as a monk weapon for the attack, which has a normal range of 20 feet and a long range of 60 feet.`,\n            3,\n            null,\n            function () {\n                return `Damage reduction: [[/r 1d10+${actor.data.data.abilities.dex.mod}+${monkLevels}]]`;\n            }),\n        new KiFeature(\"Ki: Stunning Strike\",\n            \"Starting at 5th level, you can interfere with the flow of ki in an opponentâ€™s body. When you hit another creature with a melee weapon attack, you can spend 1 ki point to attempt a stunning strike. The target must succeed on a Constitution saving throw or be <b>stunned</b> until the end of your next turn.\",\n            5,\n            null,\n            function () {\n                // Append the saving throw DC to the chat message\n                return `CON saving throw (DC [[8+${actor.data.data.abilities.wis.mod}+@attributes.prof]])`;\n            }),\n        new KiFeature(\"Ki: Diamond Soul\",\n            `Beginning at 14th level, your mastery of ki grants you proficiency in all saving throws.\n\n        Additionally, whenever you make a saving throw and fail, you can spend 1 ki point to reroll it and take the second result.`,\n            14),\n        new KiFeature(\"Ki: Empty Body\",\n            `Beginning at 18th level, you can use your action to spend 4 ki points to become invisible for 1 minute. During that time, you also have resistance to all damage but force damage.\n\n        Additionally, you can spend 8 ki points to cast the astral projection spell, without needing material components. When you do so, you canâ€™t take any other creatures with you.`,\n            18,\n            null,\n            function () {\n                return \"Note: 4 ki points have been spent. Adjust manually if casting astral projection spell.\";\n            },\n            4),\n    ];\n\n    const consumeKi = (feature, allowNegative, allowHigher) => {\n        let hasAvailableResource = false;\n        let selected = features.find(o => o.name == feature);\n        let kiCost = selected.kiCost || 1;\n\n        // Look for Resources under the Core actor data\n        let resourceKey = Object.keys(actor.data.data.resources).filter(k => actor.data.data.resources[k].label === kiName).shift();\n        if (resourceKey && (actor.data.data.resources[resourceKey].value >= kiCost || allowNegative)) {\n            hasAvailableResource = true;\n            actor.data.data.resources[resourceKey].value -= kiCost;\n        }\n\n        // Look for Ki Points Feat that has uses\n        actor.items.filter(i => i.data.name === kiName && i.hasLimitedUses && (i.data.data.uses.value >= kiCost || allowNegative)).forEach(i => {\n            hasAvailableResource = true;\n            i.data.data.uses.value -= kiCost\n        })\n\n        if (!hasAvailableResource) {\n            ui.notifications.warn(`${actor.name} does not have any ${kiName} left!`);\n            return false;\n        }\n        if (actor.sheet.rendered) {\n            // Update the actor sheet if it is currently open\n            actor.render(true);\n        }\n\n        if (selected) {\n            selected.render(allowHigher);\n        }\n\n        return true;\n    };\n\n    (async () => {\n        let template = `\n        <form>\n            <div class=\"form-group\">\n                <label>Select feature:</label>\n                <select id=\"feature\" name=\"feature\">`\n        features.filter(o => o.requireLevel <= monkLevels).forEach(o => {\n            template += `<option value=\"${o.name}\">${o.name}</option>`;\n        });\n        template += `</select>\n            </div>\n            <div class=\"form-group\">\n                <label>Allow consuming Ki into negative? <input type=\"checkbox\" id=\"allow-negative\" name=\"allow-negative\" value=\"1\"></label>\n            </div>\n            <div class=\"form-group\">\n                <label>Allow consuming Ki feats of higher level? <input type=\"checkbox\" id=\"allow-higher\" name=\"allow-higher\" value=\"1\"></label>\n            </div>\n        </form>`;\n        new Dialog({\n            title: `Monk Ki Point Spender`,\n            content: template,\n            buttons: {\n                yes: {\n                    icon: \"<i class='fas fa-check'></i>\",\n                    label: `Apply`,\n                    callback: (html) => {\n                        let feature = html.find('#feature')[0].value;\n                        let allowNegative = html.find('#allow-negative')[0].checked;\n                        let allowHigher = html.find('#allow-higher')[0].checked;\n                        consumeKi(feature, allowNegative, allowHigher);\n                    }\n                },\n                no: {\n                    icon: \"<i class='fas fa-times'></i>\",\n                    label: `Cancel`\n                },\n            },\n            default: \"yes\"\n        }).render(true);\n    })();\n})()","folder":"WCNyz4FuaFIQxYKA","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-5e.WC2Yl843kA4sjrUz"},"scene-packer":{"hash":"dc57525a2ebc117c8f1ba7dbcbb613c61d0a1080"}},"_id":"u663kaGldFdut5wI"}
{"name":"Healing Word","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Healing Word\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/heal-jade-1.jpg","actorIds":[],"_id":"v7syZNxA0CLQgXuF"}
{"name":"Detect Magic","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Detect Magic\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/light-blue-2.jpg","actorIds":[],"_id":"vBEKci2M865FNnTx"}
{"_id":"vBc6Jid4J342LMTl","name":"New Macro","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d4","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"vtu7WKSrqPdQLKjb","name":"Quest Tracker Resizable","type":"script","author":"NGNjNjcwYTg1OTY5","img":"modules/forien-quest-log/assets/icons/macros/questTrackerResizableOff.png","scope":"global","command":"const newState = !game.settings.get('forien-quest-log', 'questTrackerResizable');\nawait game.settings.set('forien-quest-log', 'questTrackerResizable', newState);","folder":"mGB5wXs6msf7dm6H","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"forien-quest-log":{"macro-setting":"questTrackerResizable"},"core":{"sourceId":"Compendium.forien-quest-log.macros-player.PUmh7HIMnMNqCht4"},"scene-packer":{"hash":"bccb01887ea799560f7dc919401e50ae39b72252"}}}
{"name":"Thunderwave","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Thunderwave\");","author":"NzA5NzhhYjk2ZDhm","img":"systems/dnd5e/icons/spells/lightning-jade-1.jpg","actorIds":[],"_id":"w3BHiutO7zGx4dxn"}
{"name":"35 - T03 - Sparks (xfire)","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/dice-target.svg","scope":"global","command":"let params =\r\n[{\r\n    filterType: \"xfire\",\r\n    filterId: \"mySparksXFire\",\r\n    time: 0,\r\n    blend: 2,\r\n    amplitude: 0.7,\r\n    dispersion: 0,\r\n    chromatic: false,\r\n    scaleX: 2,\r\n    scaleY: 2,\r\n    inlay: false,\r\n    animated :\r\n    {\r\n      time : \r\n      { \r\n        active: true, \r\n        speed: -0.0015, \r\n        animType: \"move\" \r\n      }\r\n    }\r\n}];\r\n\r\nTokenMagic.addUpdateFiltersOnSelected(params);","folder":null,"sort":0,"permission":{"default":0,"Njc5YzFjZDI5NjZl":3,"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Compendium.tokenmagic.tmMacros.GKxtep2eo55zKl1Z"}},"_id":"wFcGFFSS0eYe0Zxn"}
{"name":"Bulk pack scenes","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/barrel.svg","scope":"global","command":"// This macro will pack/repack all scenes in the requested scene folder.\n\nDialog.prompt({\n  title: 'Pack all Scenes in a folder',\n  content: '<label>Enter folder name (case sensitive): <input type=\"text\" name=\"folder\"><hr></label>',\n  label: 'Pack scenes',\n  callback: async (html) => {\n    let folderName = html.find('input').val();\n    if (!folderName) {\n      return;\n    }\n    let process = async (f, instance) => {\n      for (const scene of f.content) {\n        await instance.ClearPackedData(scene);\n        await instance.PackScene(scene);\n      }\n      for (const child of f.children) {\n        await process(child, instance);\n      }\n    }\n    const folder = game.folders.find(f => f.name === folderName && f.type === 'Scene');\n    if (folder) {\n      ScenePacker.PromptForInstance().then(async instance => {\n        await process(folder, instance);\n      })\n    } else {\n      console.error(`Could not find a Scene folder with the name \"${folderName}\"`);\n    }\n  },\n});","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.oYPUPtEzf8Dp90ZS"},"scene-packer":{"sourceId":"Macro.oYPUPtEzf8Dp90ZS","hash":"e311a94be827b8e17dbc6492d42a4f2d5b716199"}},"_id":"wRJl8pVI0wEeFpU3"}
{"name":"Erupting Earth","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"imports/dndbeyond/spell-transmutation.png","scope":"global","command":"game.dnd5e.rollItemMacro(\"Erupting Earth\");","folder":null,"sort":0,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"wVWk6UZTpX3BLMNA"}
{"_id":"whzpFNvv71qR27uk","name":"Silvered Longsword","type":"script","author":"NGIwMDczNDc3YmVi","img":"icons/weapons/swords/greatsword-crossguard-steel.webp","scope":"global","command":"game.dnd5e.rollItemMacro(\"Silvered Longsword\");","folder":null,"sort":0,"permission":{"default":0,"NGIwMDczNDc3YmVi":3},"flags":{"dnd5e":{"itemMacro":true}}}
{"name":"Dimension Door","type":"script","author":"NGIwMDczNDc3YmVi","img":"systems/dnd5e/icons/spells/air-burst-magenta-3.jpg","scope":"global","command":"game.dnd5e.rollItemMacro(\"Dimension Door\");","folder":null,"sort":0,"permission":{"default":0,"NGIwMDczNDc3YmVi":3},"flags":{"dnd5e":{"itemMacro":true}},"_id":"xEy3dzsSQYOnHiVe"}
{"_id":"xTbTm5wmIzwnAJbV","name":"Perception Roll","permission":{"default":0,"YWVjYjMyYTc5OGJj":3},"type":"chat","sort":100001,"flags":{},"scope":"global","command":"/r 1d20 + 2","author":"YWVjYjMyYTc5OGJj","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"xW9ZqfKkOpbihqIg","name":"Wild Shape","type":"script","author":"NzA5NzhhYjk2ZDhm","img":"icons/creatures/mammals/elk-moose-marked-green.webp","scope":"global","command":"game.dnd5e.rollItemMacro(\"Wild Shape\");","folder":null,"sort":100001,"permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"flags":{"dnd5e":{"itemMacro":true}}}
{"name":"Witch Bolt","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Witch Bolt\");","author":"NGIwMDczNDc3YmVi","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"xadrJi0W7lQ9rSzK"}
{"name":"Scorching Ray","permission":{"default":0,"NGIwMDczNDc3YmVi":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Scorching Ray\");","author":"NGIwMDczNDc3YmVi","img":"systems/dnd5e/icons/spells/beam-red-2.jpg","actorIds":[],"_id":"y2YDt5CjgFji9rrm"}
{"name":"Show Scenes Worth Packing","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/eye.svg","scope":"global","command":"// This macro will check your world Scenes to see whether\n// there is any data that would benefit from being Packed.\n\nScenePacker.ShowScenesWorthPacking();","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.zo5hb9xMPyiUEqrE"},"scene-packer":{"hash":"fa06912a5fd446bdcad5589029d76d4da4f4f6da"}},"_id":"yLxhIb5XwM0pYKqq"}
{"_id":"yk09EpD5KVSs0l5x","name":"UStrike Dmg","permission":{"default":0,"NThiNDE0MDE3NTcx":3},"type":"chat","sort":100001,"flags":{"combat-utility-belt":{"macroTrigger":""}},"scope":"global","command":"/r 1d8+1d6+4","author":"NThiNDE0MDE3NTcx","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"Summon Beast","permission":{"default":0,"NzA5NzhhYjk2ZDhm":3},"type":"script","sort":100001,"flags":{"dnd5e":{"itemMacro":true}},"scope":"global","command":"game.dnd5e.rollItemMacro(\"Summon Beast\");","author":"NzA5NzhhYjk2ZDhm","img":"icons/svg/mystery-man.svg","actorIds":[],"_id":"zJ1WOPFpEoRk8Q9s"}
{"name":"Detach Scene from Scene Packer instance","type":"script","author":"NGNjNjcwYTg1OTY5","img":"icons/svg/hanging-sign.svg","scope":"global","command":"// This macro will detach a scene from a Scene Packer instance, allowing you to\n// choose a different module to pack the scene against.\n// Use this macro if you accidentally pack a scene against the wrong module.\n\nconst sceneName = 'Your scene name';\ngame.scenes.filter(s => s.name === sceneName).forEach(s => s.setFlag('scene-packer', 'source-module', null))","folder":"Fv2Z0pjj2V3V1qZu","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"core":{"sourceId":"Macro.CPhN32K7a5EtMlBH"},"scene-packer":{"sourceId":"Macro.CPhN32K7a5EtMlBH","hash":"2e0c54b2c832540c956715cbf6479d4a7cc03c9e"}},"_id":"zYR7XAq5rlDFhAfF"}
{"_id":"qSemk5g4UlltsBEp","name":"Enable Quest Tracker","type":"script","author":"NGNjNjcwYTg1OTY5","img":"modules/forien-quest-log/assets/icons/macros/questTrackerEnableOn.png","scope":"global","command":"const newState = !game.settings.get('forien-quest-log', 'questTrackerEnable');\nawait game.settings.set('forien-quest-log', 'questTrackerEnable', newState);","folder":"mGB5wXs6msf7dm6H","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"forien-quest-log":{"macro-setting":"questTrackerEnable"},"core":{"sourceId":"Compendium.forien-quest-log.macros-player.03i1Qj8atS4zqJh0"},"scene-packer":{"hash":"02ab46952fbeacff5034a672ca6b89bcbd22baf9"},"combat-utility-belt":{"macroTrigger":""}}}
{"_id":"vtu7WKSrqPdQLKjb","name":"Quest Tracker Resizable","type":"script","author":"NGNjNjcwYTg1OTY5","img":"modules/forien-quest-log/assets/icons/macros/questTrackerResizableOff.png","scope":"global","command":"const newState = !game.settings.get('forien-quest-log', 'questTrackerResizable');\nawait game.settings.set('forien-quest-log', 'questTrackerResizable', newState);","folder":"mGB5wXs6msf7dm6H","sort":0,"permission":{"NGNjNjcwYTg1OTY5":3},"flags":{"forien-quest-log":{"macro-setting":"questTrackerResizable"},"core":{"sourceId":"Compendium.forien-quest-log.macros-player.PUmh7HIMnMNqCht4"},"scene-packer":{"hash":"bccb01887ea799560f7dc919401e50ae39b72252"}}}
